{% extends 'base.html' %}

{% block title %}Aptitude Quiz | Elevo{% endblock %}

{% block content %}
<style>
  /* Disable selection and copy */
  .no-copy {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }

  /* Premium Quiz Styles */
  .quiz-container {
    background: rgba(15, 23, 42, 0.4);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.05);
  }

  .nav-btn {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    font-size: 0.8rem;
    font-weight: 700;
    transition: all 0.2s;
    background: rgba(30, 41, 59, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #94a3b8;
  }

  .nav-btn.active {
    background: #38bdf8;
    color: #0f172a;
    border-color: #38bdf8;
    box-shadow: 0 0 15px rgba(56, 189, 248, 0.4);
  }

  .nav-btn.answered {
    background: rgba(20, 184, 166, 0.2);
    border-color: rgba(20, 184, 166, 0.4);
    color: #2dd4bf;
  }

  .question-card {
    display: none;
    animation: slideIn 0.3s ease-out;
  }

  .question-card.active {
    display: block;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .option-label {
    transition: all 0.2s;
    border: 1px solid rgba(255, 255, 255, 0.05);
    background: rgba(30, 41, 59, 0.3);
  }

  .option-label:hover {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(56, 189, 248, 0.3);
  }

  input[type="radio"]:checked + .option-content {
    background: rgba(56, 189, 248, 0.1);
    border-color: #38bdf8;
    color: #f8fafc;
  }
  
  .timer-glow {
    animation: timerPulse 2s infinite;
  }
  
  .timer-critical {
    animation: timerPulseCritical 0.8s infinite;
    color: #f87171 !important;
    border-color: #f87171 !important;
  }

  @keyframes timerPulse {
    0%, 100% { box-shadow: 0 0 10px rgba(56, 189, 248, 0.1); }
    50% { box-shadow: 0 0 20px rgba(56, 189, 248, 0.3); }
  }

  @keyframes timerPulseCritical {
    0%, 100% { box-shadow: 0 0 10px rgba(248, 113, 113, 0.2); background: rgba(248, 113, 113, 0.05); }
    50% { box-shadow: 0 0 25px rgba(248, 113, 113, 0.4); background: rgba(248, 113, 113, 0.15); }
  }
</style>

<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 no-copy">
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
    
    <!-- Left: Question Area -->
    <div class="lg:col-span-8 flex flex-col gap-6">
      <!-- Header -->
      <div class="flex items-center justify-between p-6 rounded-3xl bg-slate-900/40 border border-slate-800">
        <div>
          <h1 class="text-xl font-black text-white tracking-tight">Elevo Assessment Engine</h1>
          <p class="text-slate-500 text-xs font-bold uppercase tracking-widest mt-1">Session #{{ attempt.id }} · {{ attempt.total_questions }} Questions</p>
        </div>
        <div id="timer-box" class="flex flex-col items-end px-5 py-2 rounded-2xl border border-slate-700 bg-slate-900/60 timer-glow transition-all">
          <span class="text-[10px] text-slate-500 font-black uppercase tracking-widest">Time Remaining</span>
          <span id="timer" class="text-2xl font-black text-sky-400 tabular-nums">--:--</span>
        </div>
      </div>

      <!-- Question Cards container -->
      <form id="quiz-form" method="post">
        {% csrf_token %}
        <div class="quiz-container rounded-3xl p-1 shadow-2xl overflow-hidden">
          {% for q in questions %}
            <div id="q-card-{{ forloop.counter }}" class="question-card p-8 {% if forloop.first %}active{% endif %}" data-q-index="{{ forloop.counter }}">
              <div class="flex items-center justify-between mb-8">
                <span class="px-3 py-1 rounded-lg bg-sky-500/10 border border-sky-500/20 text-sky-400 text-[10px] font-bold uppercase tracking-widest">Question {{ forloop.counter }} of {{ questions|length }}</span>
                <div class="flex items-center gap-2">
                   <span class="text-[10px] text-slate-500 font-bold uppercase">{{ q.topic.name }}</span>
                   <span class="h-1 w-4 bg-slate-800 rounded-full"></span>
                   <span class="text-[10px] {% if q.difficulty == 'Hard' %}text-rose-400{% elif q.difficulty == 'Medium' %}text-amber-400{% else %}text-teal-400{% endif %} font-bold uppercase">{{ q.difficulty }}</span>
                </div>
              </div>

              <h2 class="text-2xl font-bold text-white leading-snug mb-10">{{ q.question_text }}</h2>

              <div class="grid grid-cols-1 gap-4">
                <!-- Option A -->
                <label class="option-label group relative flex items-center p-5 rounded-2xl cursor-pointer overflow-hidden transition-all">
                  <input type="radio" name="question_{{ q.id }}" value="A" class="peer hidden" onchange="markAsAnswered({{ forloop.counter }})">
                  <div class="option-content absolute inset-0 border-2 border-transparent transition-all"></div>
                  <div class="relative z-10 flex items-center w-full">
                    <span class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-800 text-slate-400 font-bold text-sm group-hover:bg-sky-500 group-hover:text-white transition-all mr-4">A</span>
                    <span class="text-slate-300 font-medium group-hover:text-white transition-colors">{{ q.option_a }}</span>
                    <i class="ri-checkbox-circle-fill ml-auto text-sky-400 opacity-0 transition-opacity peer-checked:opacity-100 text-xl"></i>
                  </div>
                </label>

                <!-- Option B -->
                <label class="option-label group relative flex items-center p-5 rounded-2xl cursor-pointer overflow-hidden transition-all">
                  <input type="radio" name="question_{{ q.id }}" value="B" class="peer hidden" onchange="markAsAnswered({{ forloop.counter }})">
                  <div class="option-content absolute inset-0 border-2 border-transparent transition-all"></div>
                  <div class="relative z-10 flex items-center w-full">
                    <span class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-800 text-slate-400 font-bold text-sm group-hover:bg-sky-500 group-hover:text-white transition-all mr-4">B</span>
                    <span class="text-slate-300 font-medium group-hover:text-white transition-colors">{{ q.option_b }}</span>
                    <i class="ri-checkbox-circle-fill ml-auto text-sky-400 opacity-0 transition-opacity peer-checked:opacity-100 text-xl"></i>
                  </div>
                </label>

                <!-- Option C -->
                <label class="option-label group relative flex items-center p-5 rounded-2xl cursor-pointer overflow-hidden transition-all">
                  <input type="radio" name="question_{{ q.id }}" value="C" class="peer hidden" onchange="markAsAnswered({{ forloop.counter }})">
                  <div class="option-content absolute inset-0 border-2 border-transparent transition-all"></div>
                  <div class="relative z-10 flex items-center w-full">
                    <span class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-800 text-slate-400 font-bold text-sm group-hover:bg-sky-500 group-hover:text-white transition-all mr-4">C</span>
                    <span class="text-slate-300 font-medium group-hover:text-white transition-colors">{{ q.option_c }}</span>
                    <i class="ri-checkbox-circle-fill ml-auto text-sky-400 opacity-0 transition-opacity peer-checked:opacity-100 text-xl"></i>
                  </div>
                </label>

                <!-- Option D -->
                <label class="option-label group relative flex items-center p-5 rounded-2xl cursor-pointer overflow-hidden transition-all">
                  <input type="radio" name="question_{{ q.id }}" value="D" class="peer hidden" onchange="markAsAnswered({{ forloop.counter }})">
                  <div class="option-content absolute inset-0 border-2 border-transparent transition-all"></div>
                  <div class="relative z-10 flex items-center w-full">
                    <span class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-800 text-slate-400 font-bold text-sm group-hover:bg-sky-500 group-hover:text-white transition-all mr-4">D</span>
                    <span class="text-slate-300 font-medium group-hover:text-white transition-colors">{{ q.option_d }}</span>
                    <i class="ri-checkbox-circle-fill ml-auto text-sky-400 opacity-0 transition-opacity peer-checked:opacity-100 text-xl"></i>
                  </div>
                </label>
              </div>
            </div>
          {% endfor %}
        </div>

        <!-- Navigation Controls -->
        <div class="flex items-center justify-between mt-8 p-6 rounded-3xl bg-slate-900/40 border border-slate-800">
          <button type="button" onclick="prevQuestion()" id="prev-btn" class="px-6 py-3 rounded-xl bg-slate-800 text-slate-400 font-bold hover:bg-slate-700 disabled:opacity-30 disabled:cursor-not-allowed transition-all flex items-center gap-2">
            <i class="ri-arrow-left-s-line"></i> Previous
          </button>
          
          <div class="hidden md:flex items-center gap-2 text-slate-500 font-bold text-xs uppercase tracking-widest">
             Step <span id="current-step-label" class="text-sky-400">1</span> of {{ questions|length }}
          </div>

          <div class="flex items-center gap-3">
            <button type="button" onclick="nextQuestion()" id="next-btn" class="px-6 py-3 rounded-xl bg-slate-800 text-slate-100 font-bold hover:bg-slate-700 transition-all flex items-center gap-2">
               Next <i class="ri-arrow-right-s-line"></i>
            </button>
            <button type="button" onclick="confirmSubmit()" class="px-8 py-3 rounded-xl bg-teal-600 hover:bg-teal-500 text-white font-black shadow-lg shadow-teal-900/20 transition-all flex items-center gap-2">
               Finish <i class="ri-check-line"></i>
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- Right: Sidebar -->
    <div class="lg:col-span-4 space-y-6">
      <!-- Question Navigator -->
      <div class="premium-card rounded-3xl p-6">
        <h3 class="text-sm font-black text-white uppercase tracking-widest mb-6 flex items-center gap-2">
          <i class="ri-grid-fill text-sky-400"></i> Navigation
        </h3>
        <div class="grid grid-cols-5 gap-3">
          {% for q in questions %}
            <button type="button" onclick="goToQuestion({{ forloop.counter }})" id="nav-btn-{{ forloop.counter }}" class="nav-btn {% if forloop.first %}active{% endif %}">
              {{ forloop.counter|stringformat:"02d" }}
            </button>
          {% endfor %}
        </div>
        
        <div class="mt-8 pt-8 border-t border-slate-800/50 space-y-3">
          <div class="flex items-center justify-between text-[11px] font-bold uppercase tracking-tighter">
            <span class="text-slate-500 flex items-center gap-2"><div class="w-3 h-3 rounded bg-sky-500"></div> Current</span>
            <span class="text-slate-500 flex items-center gap-2"><div class="w-3 h-3 rounded border border-teal-500/40 bg-teal-500/10"></div> Answered</span>
          </div>
        </div>
      </div>

      <!-- Proctoring Warnings -->
      <div class="rounded-3xl p-6 bg-rose-500/5 border border-rose-500/10">
        <h3 class="text-xs font-black text-rose-400 uppercase tracking-widest mb-3 flex items-center gap-2">
          <i class="ri-alarm-warning-line"></i> Proctoring Active
        </h3>
        <ul class="space-y-2">
          <li class="flex items-start gap-2 text-[11px] text-slate-400">
            <i class="ri-close-circle-line text-rose-400 mt-0.5"></i>
            <span>Right-click & Copy-Paste are disabled.</span>
          </li>
          <li class="flex items-start gap-2 text-[11px] text-slate-400">
            <i class="ri-close-circle-line text-rose-400 mt-0.5"></i>
            <span>Switching tabs may invalidate your session.</span>
          </li>
        </ul>
      </div>
    </div>
  </div>
</section>

<script>
  let currentIdx = 1;
  const totalQuestions = {{ questions|length }};
  const form = document.getElementById('quiz-form');
  let remaining = {{ remaining_seconds|default:0 }};

  // ── Navigation Core ──────────────────────────────────────────

  function updateNav() {
    document.querySelectorAll('.question-card').forEach(el => el.classList.remove('active'));
    document.getElementById(`q-card-${currentIdx}`).classList.add('active');
    
    document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(`nav-btn-${currentIdx}`).classList.add('active');
    
    document.getElementById('prev-btn').disabled = (currentIdx === 1);
    document.getElementById('next-btn').style.display = (currentIdx === totalQuestions) ? 'none' : 'flex';
    document.getElementById('current-step-label').textContent = currentIdx;
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function nextQuestion() {
    if (currentIdx < totalQuestions) {
      currentIdx++;
      updateNav();
    }
  }

  function prevQuestion() {
    if (currentIdx > 1) {
      currentIdx--;
      updateNav();
    }
  }

  function goToQuestion(idx) {
    currentIdx = idx;
    updateNav();
  }

  function markAsAnswered(idx) {
    document.getElementById(`nav-btn-${idx}`).classList.add('answered');
  }

  // ── Timer Logic ──────────────────────────────────────────────

  const timerEl = document.getElementById('timer');
  const timerBox = document.getElementById('timer-box');

  function renderTimer() {
    const mins = Math.floor(remaining / 60);
    const secs = remaining % 60;
    timerEl.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    
    if (remaining < 60) {
      timerBox.classList.add('timer-critical');
    }
  }

  renderTimer();

  const timerInterval = setInterval(() => {
    remaining -= 1;
    if (remaining <= 0) {
      clearInterval(timerInterval);
      timerEl.textContent = '00:00';
      window.onbeforeunload = null;
      form.submit();
      return;
    }
    renderTimer();
  }, 1000);

  // ── Security Features ─────────────────────────────────────────

  // Disable Right Click
  document.addEventListener('contextmenu', e => e.preventDefault());

  // Prevent Navigation/F5
  window.onbeforeunload = function() {
    return "Are you sure you want to leave? Your progress may be lost.";
  };

  function confirmSubmit() {
    if (confirm("Are you sure you want to finish the assessment?")) {
      window.onbeforeunload = null;
      form.submit();
    }
  }

  // Prevent Copy
  document.addEventListener('copy', e => {
    e.preventDefault();
    alert("Copying text is not allowed during the assessment.");
  });

</script>
{% endblock %}

