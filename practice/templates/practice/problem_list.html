{% extends 'base.html' %}

{% block title %}Practice Problems | Elevo{% endblock %}

{% block content %}
<div class="min-h-screen relative overflow-hidden py-12">
    <!-- Background overlay -->
    <div class="absolute inset-0 bg-gradient-to-br from-slate-900/20 via-sky-900/10 to-teal-900/20 pointer-events-none"></div>

    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative">
        <!-- Header Section -->
        <div class="mb-10 flex flex-col gap-6 lg:flex-row lg:items-end lg:justify-between animate-reveal">
            <div class="space-y-2">
                <div class="inline-flex items-center px-3 py-1 rounded-full bg-sky-500/10 border border-sky-500/30 text-sky-400 text-[10px] font-black uppercase tracking-widest mb-2">
                    Practice Arena
                </div>
                <h1 class="text-4xl sm:text-5xl font-black text-white brand-font tracking-tight">Coding Challenges</h1>
                <p class="text-slate-400 font-medium max-w-2xl">Master your programming skills with our curated collection of technical interview problems.</p>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="glass-elevated border border-white/10 rounded-2xl p-4 text-center min-w-[140px]">
                    <div class="text-3xl font-black text-white">{{ total_problems }}</div>
                    <div class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">Total Problems</div>
                </div>
                <div class="glass-elevated border border-white/10 rounded-2xl p-4 text-center min-w-[140px]">
                    <div class="text-3xl font-black text-sky-400">{{ page_obj.number }}<span class="text-slate-600">/</span>{{ page_obj.paginator.num_pages }}</div>
                    <div class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">Current Page</div>
                </div>
            </div>
        </div>

        <!-- Mastery Navigation -->
        <div class="flex flex-wrap items-center gap-4 mb-8 animate-reveal" style="animation-delay: 50ms;">
            <a href="{% url 'practice:topic_list' %}" class="px-6 py-3 rounded-2xl glass-elevated border border-white/5 hover:border-sky-500/30 flex items-center gap-3 group transition-all">
                <div class="w-8 h-8 rounded-lg bg-sky-500/10 text-sky-400 flex items-center justify-center group-hover:bg-sky-500 group-hover:text-white transition-all">
                    <i class="ri-braces-line"></i>
                </div>
                <span class="text-[10px] font-black text-white uppercase tracking-widest">Browse Topics</span>
            </a>
            <a href="{% url 'practice:company_list' %}" class="px-6 py-3 rounded-2xl glass-elevated border border-white/5 hover:border-teal-500/30 flex items-center gap-3 group transition-all">
                <div class="w-8 h-8 rounded-lg bg-teal-500/10 text-teal-400 flex items-center justify-center group-hover:bg-teal-500 group-hover:text-white transition-all">
                    <i class="ri-building-line"></i>
                </div>
                <span class="text-[10px] font-black text-white uppercase tracking-widest">Company List</span>
            </a>
            <a href="{% url 'practice:user_submissions' %}" class="px-6 py-3 rounded-2xl glass-elevated border border-white/5 hover:border-indigo-500/30 flex items-center gap-3 group transition-all">
                <div class="w-8 h-8 rounded-lg bg-indigo-500/10 text-indigo-400 flex items-center justify-center group-hover:bg-indigo-500 group-hover:text-white transition-all">
                    <i class="ri-history-line"></i>
                </div>
                <span class="text-[10px] font-black text-white uppercase tracking-widest">My Progress</span>
            </a>
        </div>

        <!-- Filter Section -->
        <div class="glass-elevated rounded-3xl border border-white/10 p-6 mb-10 animate-reveal relative z-40" style="animation-delay: 100ms;">
            <form method="get" id="filter-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
                <div class="space-y-1.5">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1">Search</label>
                    <div class="relative group">
                        <i class="ri-search-line absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 group-focus-within:text-sky-400 transition-colors"></i>
                        {{ filter_form.search }}
                    </div>
                </div>

                <!-- Custom Dropdowns -->
                {% for field in filter_form %}
                    {% if field.name != 'search' %}
                    <div class="space-y-1.5 custom-dropdown-container" data-field="{{ field.name }}">
                        <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1">{{ field.label }}</label>
                        <div class="relative">
                            <button type="button" class="dropdown-trigger w-full h-11 px-4 rounded-xl border border-white/10 bg-white/5 text-slate-300 text-[11px] font-bold text-left flex items-center justify-between hover:bg-white/10 transition-all">
                                <span class="truncate selected-text">
                                    {% if field.value %}
                                        {% for val, label in field.field.choices %}
                                            {% if val|stringformat:"s" == field.value|stringformat:"s" %}{{ label }}{% endif %}
                                        {% endfor %}
                                    {% else %}
                                        {{ field.field.choices.0.1 }}
                                    {% endif %}
                                </span>
                                <i class="ri-arrow-down-s-line text-slate-500 transition-transform dropdown-icon"></i>
                            </button>
                            <!-- Hidden Native Select -->
                            <div class="hidden">{{ field }}</div>
                            <!-- Styled Menu -->
                            <div class="dropdown-menu absolute z-50 top-full left-0 w-full mt-2 bg-slate-900/95 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl overflow-hidden opacity-0 invisible scale-95 transition-all duration-200 origin-top">
                                <div class="max-h-64 overflow-y-auto custom-scrollbar">
                                    {% for val, label in field.field.choices %}
                                    <button type="button" class="dropdown-item w-full px-4 py-3 text-left text-[11px] font-bold text-slate-400 hover:text-white hover:bg-white/5 transition-colors border-b border-white/5 last:border-0" data-value="{{ val }}">
                                        {{ label }}
                                    </button>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}

                <div class="flex items-end gap-2">
                    <button type="submit" class="flex-1 py-2.5 rounded-xl bg-gradient-to-r from-sky-500 to-indigo-600 text-white font-black uppercase tracking-widest text-[10px] shadow-lg shadow-sky-500/20 hover:scale-[1.02] active:scale-95 transition-all">
                        Apply
                    </button>
                    <a href="{% url 'practice:problem-list' %}" class="px-3 py-2.5 rounded-xl border border-white/10 bg-white/5 text-slate-400 hover:text-white hover:bg-white/10 transition-all flex items-center justify-center">
                        <i class="ri-refresh-line"></i>
                    </a>
                </div>
            </form>
        </div>

        <!-- Problems Grid -->
        <div class="grid grid-cols-1 gap-4 mb-10">
            {% for problem in page_obj %}
            <div class="problem-card group animate-reveal" style="animation-delay: {{ forloop.counter0|add:2 }}00ms;">
                <div class="glass-elevated rounded-2xl border border-white/5 hover:border-white/20 transition-all duration-500 overflow-hidden relative">
                    <!-- Progress Bar (Subtle) -->
                    <div class="absolute top-0 left-0 h-[2px] bg-gradient-to-r from-sky-500 to-teal-500 transition-all duration-1000 w-0 group-hover:w-full opacity-0 group-hover:opacity-100"></div>

                    <div class="p-6">
                        <div class="flex flex-col lg:flex-row lg:items-center gap-6">
                            <!-- Problem Badge/Number -->
                            <div class="flex-shrink-0">
                                <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-slate-800 to-slate-900 border border-white/10 flex flex-col items-center justify-center shadow-2xl group-hover:scale-110 group-hover:border-sky-500/30 transition-all duration-500">
                                    <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">No.</span>
                                    <span class="text-xl font-black text-white">{{ problem.problem_number }}</span>
                                </div>
                            </div>

                            <!-- Main Content -->
                            <div class="flex-1 min-w-0">
                                <div class="flex flex-wrap items-center gap-3 mb-2">
                                    <a href="{% url 'practice:problem_detail' problem.slug %}" class="text-xl sm:text-2xl font-black text-white tracking-tight hover:text-sky-400 transition-colors truncate">
                                        {{ problem.title }}
                                    </a>
                                    
                                    {% if problem.difficulty == 'easy' %}
                                        <span class="px-2.5 py-0.5 rounded-full text-[9px] font-black uppercase tracking-widest bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">Easy</span>
                                    {% elif problem.difficulty == 'medium' %}
                                        <span class="px-2.5 py-0.5 rounded-full text-[9px] font-black uppercase tracking-widest bg-amber-500/10 text-amber-400 border border-amber-500/20">Medium</span>
                                    {% else %}
                                        <span class="px-2.5 py-0.5 rounded-full text-[9px] font-black uppercase tracking-widest bg-rose-500/10 text-rose-400 border border-rose-500/20">Hard</span>
                                    {% endif %}

                                    {% if user.is_authenticated %}
                                        {% if problem.user_status == 'solved' %}
                                            <span class="inline-flex items-center gap-1.5 text-emerald-400 text-[10px] font-black uppercase tracking-widest">
                                                <i class="ri-checkbox-circle-fill text-sm"></i> Solved
                                            </span>
                                        {% elif problem.user_status == 'attempted' %}
                                            <span class="inline-flex items-center gap-1.5 text-sky-400 text-[10px] font-black uppercase tracking-widest">
                                                <i class="ri-time-fill text-sm"></i> Attempted
                                            </span>
                                        {% endif %}
                                    {% endif %}
                                </div>

                                <!-- Tags & Meta -->
                                <div class="flex flex-wrap items-center gap-y-2 gap-x-4">
                                    <div class="flex items-center gap-1.5">
                                        <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Topics:</span>
                                        <div class="flex flex-wrap gap-1">
                                            {% for t in problem.topics.all|slice:":3" %}
                                                <span class="px-2 py-0.5 rounded-md bg-white/5 border border-white/5 text-[10px] font-bold text-slate-400">{{ t.name }}</span>
                                            {% empty %}
                                                <span class="text-[10px] font-bold text-slate-600 italic">None</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center gap-1.5 border-l border-white/5 pl-4 ml-0.5">
                                        <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Companies:</span>
                                        <div class="flex flex-wrap gap-1">
                                            {% for c in problem.companies.all|slice:":2" %}
                                                <span class="px-2 py-0.5 rounded-md bg-white/5 border border-white/5 text-[10px] font-bold text-slate-400">{{ c.name }}</span>
                                            {% empty %}
                                                <span class="text-[10px] font-bold text-slate-600 italic">Open</span>
                                            {% endfor %}
                                        </div>
                                    </div>

                                    <div class="flex items-center gap-1.5 border-l border-white/5 pl-4">
                                        <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Acceptance:</span>
                                        <span class="text-[11px] font-black text-slate-300">{{ problem.acceptance_rate }}%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Action -->
                            <div class="flex-shrink-0 flex items-center gap-3">
                                <a href="{% url 'practice:problem_detail' problem.slug %}" class="h-12 px-6 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center text-white font-black uppercase tracking-widest text-[10px] hover:bg-sky-500 hover:border-sky-400 hover:shadow-lg hover:shadow-sky-500/20 transition-all">
                                    Solve Challenge
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="glass-elevated rounded-3xl border border-dashed border-white/10 p-20 text-center animate-reveal">
                <div class="w-20 h-20 rounded-full bg-white/5 flex items-center justify-center mx-auto mb-6">
                    <i class="ri-ghost-line text-4xl text-slate-600"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-400 tracking-tight">Challenge list looks empty.</h3>
                <p class="text-slate-500 mt-2">Adjust your filters to see more programming problems.</p>
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if page_obj.paginator.num_pages > 1 %}
        <div class="flex items-center justify-between p-6 glass-elevated border border-white/10 rounded-3xl animate-reveal" style="animation-delay: 500ms;">
            <div class="text-[10px] font-black text-slate-500 uppercase tracking-widest">
                Showing <span class="text-white">{{ page_obj.start_index }}-{{ page_obj.end_index }}</span> of <span class="text-white">{{ page_obj.paginator.count }}</span>
            </div>
            <div class="flex items-center gap-2">
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search|urlencode }}{% endif %}{% if request.GET.difficulty %}&difficulty={{ request.GET.difficulty }}{% endif %}{% if request.GET.topic %}&topic={{ request.GET.topic }}{% endif %}{% if request.GET.company %}&company={{ request.GET.company }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" class="w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 border border-white/5 text-slate-400 hover:text-white transition-all">
                        <i class="ri-arrow-left-s-line"></i>
                    </a>
                {% endif %}
                
                <div class="px-4 py-2 rounded-xl bg-sky-500/10 border border-sky-500/30 text-sky-400 text-xs font-black">
                    {{ page_obj.number }}
                </div>
                
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search|urlencode }}{% endif %}{% if request.GET.difficulty %}&difficulty={{ request.GET.difficulty }}{% endif %}{% if request.GET.topic %}&topic={{ request.GET.topic }}{% endif %}{% if request.GET.company %}&company={{ request.GET.company }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" class="w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 border border-white/5 text-slate-400 hover:text-white transition-all">
                        <i class="ri-arrow-right-s-line"></i>
                    </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </section>
</div>

<style>
    /* Custom styles for filters to match branding */
    .glass-elevated input {
        width: 100%;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 10px 14px;
        color: #f1f5f9;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        transition: all 0.3s ease;
    }
    
    .glass-elevated input:focus {
        outline: none;
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(14, 165, 233, 0.4);
        box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
    }

    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }

    .animate-reveal {
        opacity: 0;
        transform: translateY(20px);
    }

    /* Dropdown Animation States */
    .custom-dropdown-container.active .dropdown-menu {
        opacity: 1;
        visibility: visible;
        transform: scale(1);
    }
    .custom-dropdown-container.active .dropdown-icon {
        transform: rotate(180deg);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Animation
        if (typeof gsap !== 'undefined') {
            gsap.to(".animate-reveal", {
                opacity: 1,
                y: 0,
                duration: 0.8,
                stagger: 0.1,
                ease: "power2.out"
            });
        }

        // Custom Dropdown Logic
        const dropdowns = document.querySelectorAll('.custom-dropdown-container');
        
        dropdowns.forEach(container => {
            const trigger = container.querySelector('.dropdown-trigger');
            const menu = container.querySelector('.dropdown-menu');
            const items = container.querySelectorAll('.dropdown-item');
            const select = container.querySelector('select');
            const selectedText = container.querySelector('.selected-text');

            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                // Close others
                dropdowns.forEach(other => {
                    if (other !== container) other.classList.remove('active');
                });
                container.classList.toggle('active');
            });

            items.forEach(item => {
                item.addEventListener('click', () => {
                    const value = item.dataset.value;
                    select.value = value;
                    selectedText.textContent = item.textContent.trim();
                    container.classList.remove('active');
                    
                    // Trigger change if needed (e.g. for IDE language)
                    const event = new Event('change');
                    select.dispatchEvent(event);
                });
            });
        });

        // Close on outside click
        document.addEventListener('click', () => {
            dropdowns.forEach(d => d.classList.remove('active'));
        });
    });
</script>
{% endblock %}
