{% extends 'base.html' %}

{% block title %}{{ problem.title }} | Practice | Elevo{% endblock %}

{% block content %}
<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="mb-6 flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
    <div>
      <a href="{% url 'practice:problem-list' %}" class="text-sm text-slate-400 hover:text-teal-300 inline-flex items-center gap-1 mb-2"><i class="ri-arrow-left-line"></i> Back to list</a>
      <h1 class="text-3xl font-bold text-white">{{ problem.problem_number }}. {{ problem.title }}</h1>
      <div class="mt-3 flex flex-wrap items-center gap-2">
        {% if problem.difficulty == 'easy' %}
          <span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-emerald-500/15 text-emerald-300 border border-emerald-500/30">Easy</span>
        {% elif problem.difficulty == 'medium' %}
          <span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-yellow-500/15 text-yellow-300 border border-yellow-500/30">Medium</span>
        {% else %}
          <span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-red-500/15 text-red-300 border border-red-500/30">Hard</span>
        {% endif %}
        <span class="px-2.5 py-1 rounded-full text-xs bg-slate-800 border border-slate-600 text-slate-300">Acceptance {{ problem.acceptance_rate }}%</span>
        {% if user_progress %}
          {% if user_progress.status == 'solved' %}
            <span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-emerald-500/15 text-emerald-300 border border-emerald-500/30">Solved</span>
          {% elif user_progress.status == 'attempted' %}
            <span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-sky-500/15 text-sky-300 border border-sky-500/30">Attempted</span>
          {% endif %}
        {% endif %}
      </div>
    </div>
    <div class="flex flex-wrap gap-2">
      <a href="{% url 'practice:user_submissions' %}" class="px-4 py-2 rounded-lg border border-slate-600 text-slate-300 hover:border-teal-400 hover:text-teal-300">My Submissions</a>
      <a href="{% url 'practice:editorial' problem.slug %}" class="px-4 py-2 rounded-lg bg-slate-800 border border-slate-600 text-slate-200 hover:border-emerald-400 hover:text-emerald-300">Editorial</a>
    </div>
  </div>

  <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
    <div class="space-y-5">
      <div class="rounded-2xl border border-slate-700 bg-slate-900/65 p-5">
        <h2 class="text-lg font-semibold text-white mb-3">Problem Statement</h2>
        <div class="prose prose-invert prose-sm max-w-none text-slate-200 leading-relaxed">{{ problem.description|safe }}</div>
      </div>

      {% if problem.constraints %}
      <div class="rounded-2xl border border-slate-700 bg-slate-900/65 p-5">
        <h3 class="text-base font-semibold text-white mb-2">Constraints</h3>
        <div class="text-slate-300 text-sm whitespace-pre-line">{{ problem.constraints }}</div>
      </div>
      {% endif %}

      {% if sample_test_cases %}
      <div class="rounded-2xl border border-slate-700 bg-slate-900/65 p-5">
        <h3 class="text-base font-semibold text-white mb-3">Sample Test Cases</h3>
        <div class="space-y-3">
          {% for tc in sample_test_cases %}
          <div class="rounded-xl border border-slate-700 bg-slate-800/70 p-3">
            <p class="text-xs uppercase text-slate-400 mb-1">Input</p>
            <pre class="text-sm text-slate-200 whitespace-pre-wrap">{{ tc.input_data }}</pre>
            <p class="text-xs uppercase text-slate-400 mb-1 mt-3">Output</p>
            <pre class="text-sm text-slate-200 whitespace-pre-wrap">{{ tc.expected_output }}</pre>
            {% if tc.explanation %}
              <p class="text-xs text-slate-400 mt-2">{{ tc.explanation }}</p>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <div class="rounded-2xl border border-slate-700 bg-slate-900/65 p-5">
        <h3 class="text-base font-semibold text-white mb-2">Tags</h3>
        <div class="flex flex-wrap gap-2">
          {% for topic in problem.topics.all %}
            <span class="px-2.5 py-1 rounded-lg text-xs bg-slate-800 border border-slate-600 text-slate-300">{{ topic.name }}</span>
          {% empty %}<span class="text-slate-500 text-sm">No topics tagged</span>{% endfor %}
        </div>
        <div class="mt-3 flex flex-wrap gap-2">
          {% for company in problem.companies.all %}
            <span class="px-2.5 py-1 rounded-lg text-xs bg-slate-800 border border-slate-600 text-slate-300">{{ company.name }}</span>
          {% empty %}<span class="text-slate-500 text-sm">No companies tagged</span>{% endfor %}
        </div>
      </div>
    </div>

    <div class="space-y-5">
      <div class="rounded-2xl border border-slate-700 bg-slate-900/65 p-5">
        <div class="flex flex-col sm:flex-row sm:items-center gap-3 mb-3">
          <div class="flex-1">
            <label for="language" class="block text-xs text-slate-400 mb-1">Language</label>
            <select id="language" class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-600 text-slate-100 focus:outline-none focus:ring-2 focus:ring-teal-500">
              {% for value,label in available_languages %}
                <option value="{{ value }}" {% if code_template and code_template.language == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="sm:pt-5">
            <button id="load-template" type="button" class="px-4 py-2 rounded-xl border border-slate-600 text-slate-300 hover:border-teal-400 hover:text-teal-300">Reload Template</button>
          </div>
        </div>

        <label for="code" class="block text-xs text-slate-400 mb-1">Code</label>
        <textarea id="code" class="w-full h-72 rounded-xl border border-slate-600 bg-slate-950 text-slate-100 p-4 font-mono text-sm leading-6 focus:outline-none focus:ring-2 focus:ring-sky-500">{% if code_template %}{{ code_template.template_code }}{% endif %}</textarea>

        <div class="mt-4 flex flex-wrap gap-2">
          {% if user.is_authenticated %}
            <button id="run-btn" class="px-4 py-2 rounded-xl border border-sky-500/40 bg-sky-500/10 text-sky-200 hover:bg-sky-500/20">Run Code</button>
            <button id="submit-btn" class="px-4 py-2 rounded-xl bg-gradient-to-r from-sky-600 to-teal-600 hover:from-sky-700 hover:to-teal-700 text-white font-semibold">Submit</button>
          {% else %}
            <a href="{% url 'login' %}" class="px-4 py-2 rounded-xl bg-gradient-to-r from-sky-600 to-teal-600 text-white font-semibold">Login to Run/Submit</a>
          {% endif %}
        </div>
      </div>

      <div id="result-card" class="hidden rounded-2xl border border-slate-700 bg-slate-900/65 p-5">
        <h3 class="text-base font-semibold text-white mb-3">Execution Result</h3>
        <div id="result-summary" class="mb-3 text-sm"></div>
        <div id="result-body" class="space-y-2"></div>
      </div>

      {% if user.is_authenticated %}
      <div class="rounded-2xl border border-slate-700 bg-slate-900/65 p-5">
        <h3 class="text-base font-semibold text-white mb-3">Recent Submissions</h3>
        <div class="space-y-2">
          {% for s in user_submissions %}
            <a href="{% url 'practice:submission_detail' s.id %}" class="block rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2 hover:border-teal-400 transition-colors">
              <div class="flex items-center justify-between text-sm">
                <span class="text-slate-200">{{ s.get_status_display }}</span>
                <span class="text-slate-400">{{ s.created_at|date:"M d, H:i" }}</span>
              </div>
              <div class="text-xs text-slate-400 mt-1">{{ s.language }} | {{ s.passed_test_cases }}/{{ s.total_test_cases }}</div>
            </a>
          {% empty %}
            <p class="text-sm text-slate-500">No submissions yet for this problem.</p>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</section>

{% if user.is_authenticated %}
<script>
function getCsrfToken() {
  const cookie = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
  return cookie ? cookie.split('=')[1] : '';
}

function setLoading(btn, loading, text) {
  if (!btn) return;
  btn.disabled = loading;
  btn.textContent = loading ? text : btn.dataset.default;
}

function showResult(summaryHtml, entriesHtml) {
  const card = document.getElementById('result-card');
  document.getElementById('result-summary').innerHTML = summaryHtml;
  document.getElementById('result-body').innerHTML = entriesHtml;
  card.classList.remove('hidden');
  card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

async function loadTemplate() {
  const language = document.getElementById('language').value;
  const url = "{% url 'practice:get_code_template' problem.slug %}?language=" + encodeURIComponent(language);
  const res = await fetch(url);
  const data = await res.json();
  if (data.success) {
    document.getElementById('code').value = data.template_code;
  }
}

async function runOrSubmit(action) {
  const code = document.getElementById('code').value;
  const language = document.getElementById('language').value;
  const runBtn = document.getElementById('run-btn');
  const submitBtn = document.getElementById('submit-btn');

  if (!code.trim()) {
    showResult('<p class="text-red-300">Code is empty.</p>', '');
    return;
  }

  runBtn.dataset.default = runBtn.dataset.default || runBtn.textContent;
  submitBtn.dataset.default = submitBtn.dataset.default || submitBtn.textContent;
  setLoading(runBtn, action === 'run', 'Running...');
  setLoading(submitBtn, action === 'submit', 'Submitting...');

  const form = new FormData();
  form.append('code', code);
  form.append('language', language);

  const endpoint = action === 'run'
    ? "{% url 'practice:run_code' problem.slug %}"
    : "{% url 'practice:submit_code' problem.slug %}";

  try {
    const res = await fetch(endpoint, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCsrfToken() },
      body: form,
    });
    const data = await res.json();

    if (!res.ok) {
      showResult(`<p class="text-red-300">${data.error || 'Request failed'}</p>`, '');
      return;
    }

    if (action === 'run') {
      const summary = data.all_passed
        ? '<p class="text-emerald-300 font-semibold">All sample test cases passed.</p>'
        : '<p class="text-yellow-300 font-semibold">Some sample test cases failed.</p>';

      let body = '';
      (data.results || []).forEach((r, i) => {
        body += `
          <div class="rounded-lg border ${r.passed ? 'border-emerald-500/30 bg-emerald-500/10' : 'border-red-500/30 bg-red-500/10'} p-3 text-sm">
            <p class="font-semibold ${r.passed ? 'text-emerald-200' : 'text-red-200'}">Case ${i + 1}: ${r.passed ? 'Passed' : 'Failed'}</p>
            <p class="text-slate-300 mt-1"><span class="text-slate-400">Input:</span> ${r.input}</p>
            <p class="text-slate-300"><span class="text-slate-400">Expected:</span> ${r.expected}</p>
            <p class="text-slate-300"><span class="text-slate-400">Output:</span> ${r.output}</p>
          </div>`;
      });
      showResult(summary, body);
    } else {
      const ok = data.accepted;
      const summary = ok
        ? `<p class="text-emerald-300 font-semibold">Accepted. ${data.passed_test_cases}/${data.total_test_cases} passed.</p>`
        : `<p class="text-yellow-300 font-semibold">${data.status_display}. ${data.passed_test_cases}/${data.total_test_cases} passed.</p>`;

      let body = `<div class="text-sm text-slate-300">${data.message || ''}</div>`;
      if (data.failed_test_case) {
        body += `
          <div class="mt-2 rounded-lg border border-red-500/30 bg-red-500/10 p-3 text-sm text-red-200">
            Failed at test case ${data.failed_test_case.test_case_number}
          </div>`;
      }
      if (data.submission_id) {
        const submissionBase = "{% url 'practice:submission_detail' 0 %}".replace('/0/', '/');
        body += `<a class="inline-flex mt-3 px-3 py-2 rounded-lg bg-slate-800 border border-slate-600 text-slate-200 hover:border-teal-400" href="${submissionBase}${data.submission_id}/">View submission</a>`;
      }
      showResult(summary, body);
    }
  } catch (err) {
    showResult('<p class="text-red-300">Network error occurred.</p>', '');
  } finally {
    setLoading(runBtn, false);
    setLoading(submitBtn, false);
  }
}

document.getElementById('load-template').addEventListener('click', loadTemplate);
document.getElementById('run-btn').addEventListener('click', () => runOrSubmit('run'));
document.getElementById('submit-btn').addEventListener('click', () => runOrSubmit('submit'));
</script>
{% endif %}
{% endblock %}
