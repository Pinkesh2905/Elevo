{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}Interview Review | MockMate{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          primary: {
            50: '#eff6ff',
            500: '#3b82f6',
            600: '#2563eb',
            700: '#1d4ed8',
            900: '#1e3a8a'
          }
        }
      }
    }
  }
</script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
  
  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  }
  
  @keyframes pulse-subtle {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.85; }
  }
  
  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes scaleIn {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }
  
  @keyframes rotateIn {
    from {
      opacity: 0;
      transform: rotate(-180deg) scale(0.5);
    }
    to {
      opacity: 1;
      transform: rotate(0deg) scale(1);
    }
  }
  
  .animate-pulse-subtle {
    animation: pulse-subtle 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  
  .animate-slide-up {
    animation: slideUp 0.4s ease-out;
  }
  
  .animate-fade-in {
    animation: fadeIn 0.3s ease-out;
  }
  
  .animate-scale-in {
    animation: scaleIn 0.3s ease-out;
  }
  
  .animate-rotate-in {
    animation: rotateIn 0.6s ease-out;
  }
  
  .glass-card {
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.12);
  }
  
  .gradient-bg {
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
  }
  
  /* Score circle animation */
  .score-ring {
    transform: rotate(-90deg);
    transform-origin: center;
  }
  
  .score-progress {
    stroke-dasharray: 314;
    stroke-dashoffset: 314;
    transition: stroke-dashoffset 2s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  /* Custom scrollbar */
  .custom-scrollbar::-webkit-scrollbar { width: 8px; }
  .custom-scrollbar::-webkit-scrollbar-track { background: rgba(148, 163, 184, 0.1); }
  .custom-scrollbar::-webkit-scrollbar-thumb { 
    background: rgba(148, 163, 184, 0.4); 
    border-radius: 4px; 
  }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(148, 163, 184, 0.6); }
  
  /* Print styles */
  @media print {
    body { background: white !important; }
    .glass-card { 
      background: white !important;
      border: 1px solid #e5e7eb !important;
      box-shadow: none !important;
    }
    .gradient-bg { background: white !important; }
    .no-print { display: none !important; }
    .transcript-container { max-height: none !important; }
  }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen text-white">
  <!-- Header Section -->
  <div class="bg-black/20 backdrop-blur-sm border-b border-white/10 sticky top-0 z-50 no-print">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-20">
        <!-- Logo and Title -->
        <div class="flex items-center space-x-4">
          <div class="relative w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center animate-rotate-in">
            <i class="fas fa-file-alt text-xl text-white"></i>
          </div>
          <div>
            <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
              Interview Review
            </h1>
            <p class="text-sm text-gray-400">Session #{{ session.id }}</p>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex items-center gap-3">
          <button onclick="window.print()" 
                  class="glass-card px-4 py-2.5 rounded-xl font-medium text-blue-300 border border-blue-400/30 hover:bg-blue-500/20 transition-all duration-200 flex items-center space-x-2">
            <i class="fas fa-print"></i>
            <span class="hidden sm:inline">Print</span>
          </button>
          <a href="{% url 'mock_interview:my_mock_interviews' %}" 
             class="glass-card px-4 py-2.5 rounded-xl font-medium text-gray-300 border border-white/20 hover:bg-white/10 transition-all duration-200 flex items-center space-x-2">
            <i class="fas fa-arrow-left"></i>
            <span class="hidden sm:inline">Back</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Session Overview Card -->
    <article class="glass-card rounded-2xl overflow-hidden mb-6 animate-slide-up">
      <div class="p-6 bg-gradient-to-r from-slate-900/50 to-blue-900/20 border-b border-white/10">
        <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
          <div class="flex-1">
            <h2 class="text-2xl font-bold text-white mb-2 flex items-center space-x-3">
              <i class="fas fa-briefcase text-blue-400"></i>
              <span>{{ session.job_role }} Interview</span>
            </h2>
            <div class="flex items-center space-x-2 text-sm text-gray-400">
              <i class="fas fa-calendar-alt text-blue-400"></i>
              <time>{{ session.start_time|date:"F j, Y \a\t g:i A" }}</time>
            </div>
          </div>
          
          <div class="flex items-center gap-3 flex-wrap">
            <!-- Status Badge -->
            {% if session.status == 'COMPLETED' or session.status == 'REVIEWED' %}
              <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-emerald-500/20 text-emerald-300 border border-emerald-400/30 rounded-full text-xs font-semibold uppercase tracking-wide">
                <i class="fas fa-check-circle"></i>
                <span>Completed</span>
              </span>
            {% endif %}
            
            <!-- Score Display -->
            {% if session.score %}
              <div class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-500/20 to-indigo-500/20 border border-blue-400/30 rounded-xl">
                <i class="fas fa-chart-line text-blue-400"></i>
                <span class="text-lg font-bold text-blue-300">{{ session.score }}%</span>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Session Stats -->
      <div class="p-6">
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="glass-card rounded-xl p-4 border border-white/10">
            <div class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-2">
              <i class="fas fa-clock text-blue-400 mr-2"></i>Duration
            </div>
            <div class="text-lg font-bold text-white">
              {{ interview_metrics.duration_minutes|default:"N/A" }}
              {% if interview_metrics.duration_minutes %}min{% endif %}
            </div>
          </div>
          
          <div class="glass-card rounded-xl p-4 border border-white/10">
            <div class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-2">
              <i class="fas fa-question-circle text-indigo-400 mr-2"></i>Questions
            </div>
            <div class="text-lg font-bold text-white">
              {{ interview_metrics.total_questions|default:"0" }}
            </div>
          </div>
          
          <div class="glass-card rounded-xl p-4 border border-white/10">
            <div class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-2">
              <i class="fas fa-comment text-purple-400 mr-2"></i>Responses
            </div>
            <div class="text-lg font-bold text-white">
              {{ interview_metrics.total_words|default:"0" }} words
            </div>
          </div>
          
          <div class="glass-card rounded-xl p-4 border border-white/10">
            <div class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-2">
              <i class="fas fa-chart-bar text-emerald-400 mr-2"></i>Avg Length
            </div>
            <div class="text-lg font-bold text-white">
              {{ interview_metrics.avg_response_length|default:"0" }} words
            </div>
          </div>
        </div>
        
        <!-- Key Skills -->
        {% if session.key_skills %}
          <div class="flex items-start gap-3 pb-4 border-b border-white/10">
            <div class="flex-shrink-0 w-10 h-10 bg-indigo-500/20 rounded-lg flex items-center justify-center border border-indigo-400/30">
              <i class="fas fa-code text-indigo-400"></i>
            </div>
            <div class="flex-1 min-w-0">
              <div class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-2">
                Target Skills
              </div>
              <div class="flex flex-wrap gap-2">
                {% for skill in session.key_skills|split:"," %}
                  <span class="inline-block px-3 py-1 bg-indigo-500/20 text-indigo-300 border border-indigo-400/30 rounded-lg text-xs font-medium">
                    {{ skill|trim_whitespace }}
                  </span>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endif %}
      </div>
    </article>

    <!-- Performance Score Section -->
    {% if ai_feedback %}
      <article class="glass-card rounded-2xl overflow-hidden mb-6 animate-slide-up" style="animation-delay: 0.1s;">
        <div class="p-6 bg-gradient-to-r from-slate-900/50 to-purple-900/20 border-b border-white/10">
          <h2 class="text-xl font-bold text-white flex items-center space-x-3">
            <i class="fas fa-trophy text-yellow-400"></i>
            <span>Performance Analysis</span>
          </h2>
        </div>
        
        <div class="p-6">
          <!-- Score Circle -->
          <div class="flex flex-col md:flex-row items-center justify-center gap-8 mb-8">
            <div class="relative">
              <svg class="score-ring w-40 h-40" viewBox="0 0 120 120">
                <circle class="stroke-white/10" cx="60" cy="60" r="50" fill="none" stroke-width="8" stroke-linecap="round"></circle>
                <circle id="score-progress" class="score-progress stroke-blue-500" cx="60" cy="60" r="50" fill="none" stroke-width="8" stroke-linecap="round"></circle>
              </svg>
              <div class="absolute inset-0 flex items-center justify-center">
                <div class="text-center">
                  <div class="text-4xl font-bold text-white">{{ ai_feedback.overall_score|default:session.score|default:"N/A" }}</div>
                  <div class="text-xs text-gray-400 uppercase tracking-wide">Overall</div>
                </div>
              </div>
            </div>
            
            <!-- Additional Scores -->
            <div class="grid grid-cols-2 gap-4">
              <div class="glass-card rounded-xl p-4 border border-white/10 text-center">
                <div class="text-2xl font-bold text-blue-300 mb-1">
                  {{ ai_feedback.communication_score|default:interview_metrics.confidence_score|default:"N/A" }}
                </div>
                <div class="text-xs text-gray-400 uppercase tracking-wide">Communication</div>
              </div>
              
              <div class="glass-card rounded-xl p-4 border border-white/10 text-center">
                <div class="text-2xl font-bold text-purple-300 mb-1">
                  {{ interview_metrics.engagement_score|default:"N/A" }}
                </div>
                <div class="text-xs text-gray-400 uppercase tracking-wide">Engagement</div>
              </div>
              
              <div class="glass-card rounded-xl p-4 border border-white/10 text-center col-span-2">
                <div class="text-lg font-bold text-emerald-300 mb-1">
                  {{ ai_feedback.confidence_level|default:"Good" }}
                </div>
                <div class="text-xs text-gray-400 uppercase tracking-wide">Confidence Level</div>
              </div>
            </div>
          </div>
          
          <!-- Strengths -->
          {% if ai_feedback.strengths %}
            <div class="mb-6">
              <h3 class="text-lg font-semibold text-white mb-3 flex items-center gap-2">
                <i class="fas fa-check-circle text-emerald-400"></i>
                Strengths
              </h3>
              <div class="space-y-2">
                {% for strength in ai_feedback.strengths %}
                  <div class="glass-card rounded-lg p-3 border border-emerald-400/30 bg-emerald-500/10">
                    <p class="text-sm text-gray-300">{{ strength }}</p>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}
          
          <!-- Areas for Improvement -->
          {% if ai_feedback.areas_for_improvement %}
            <div class="mb-6">
              <h3 class="text-lg font-semibold text-white mb-3 flex items-center gap-2">
                <i class="fas fa-arrow-up text-blue-400"></i>
                Areas for Improvement
              </h3>
              <div class="space-y-2">
                {% for area in ai_feedback.areas_for_improvement %}
                  <div class="glass-card rounded-lg p-3 border border-blue-400/30 bg-blue-500/10">
                    <p class="text-sm text-gray-300">{{ area }}</p>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}
          
          <!-- Recommendations -->
          {% if ai_feedback.recommendations %}
            <div class="mb-6">
              <h3 class="text-lg font-semibold text-white mb-3 flex items-center gap-2">
                <i class="fas fa-lightbulb text-yellow-400"></i>
                Recommendations
              </h3>
              <div class="space-y-2">
                {% for recommendation in ai_feedback.recommendations %}
                  <div class="glass-card rounded-lg p-3 border border-yellow-400/30 bg-yellow-500/10">
                    <p class="text-sm text-gray-300">{{ recommendation }}</p>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}
          
          <!-- Technical Assessment -->
          {% if ai_feedback.technical_assessment %}
            <div class="glass-card rounded-xl p-4 border border-purple-400/30 bg-purple-500/10">
              <h3 class="text-sm font-semibold text-purple-300 mb-2 flex items-center gap-2">
                <i class="fas fa-code text-purple-400"></i>
                Technical Assessment
              </h3>
              <p class="text-sm text-gray-300">{{ ai_feedback.technical_assessment }}</p>
            </div>
          {% endif %}
          
          <!-- Encouragement Note -->
          {% if ai_feedback.encouragement_note %}
            <div class="mt-6 glass-card rounded-xl p-4 border border-blue-400/30 bg-gradient-to-r from-blue-500/10 to-indigo-500/10">
              <div class="flex items-start gap-3">
                <div class="flex-shrink-0 w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                  <i class="fas fa-heart text-white text-sm"></i>
                </div>
                <div>
                  <h4 class="font-semibold text-white text-sm mb-1">Final Thoughts</h4>
                  <p class="text-sm text-gray-300">{{ ai_feedback.encouragement_note }}</p>
                </div>
              </div>
            </div>
          {% endif %}
        </div>
      </article>
    {% endif %}

    <!-- Interview Transcript -->
    <article class="glass-card rounded-2xl overflow-hidden mb-6 animate-slide-up" style="animation-delay: 0.2s;">
      <div class="p-6 bg-gradient-to-r from-slate-900/50 to-green-900/20 border-b border-white/10">
        <h2 class="text-xl font-bold text-white flex items-center space-x-3">
          <i class="fas fa-comments text-green-400"></i>
          <span>Interview Transcript</span>
        </h2>
      </div>
      
      <div class="p-0">
        <div class="max-h-[600px] overflow-y-auto custom-scrollbar">
          {% for turn in turns %}
            {% if turn.ai_question %}
              <div class="border-b border-white/10 p-4 bg-purple-500/5 hover:bg-purple-500/10 transition-colors">
                <div class="flex gap-4">
                  <div class="flex-shrink-0">
                    <div class="w-10 h-10 bg-purple-500/20 rounded-full flex items-center justify-center border border-purple-400/30">
                      <i class="fas fa-robot text-purple-400"></i>
                    </div>
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-sm font-semibold text-purple-300">Sarah (AI Interviewer)</span>
                      <span class="text-xs text-gray-500">Q{{ turn.turn_number }}</span>
                    </div>
                    <p class="text-sm text-gray-300 leading-relaxed">{{ turn.ai_question }}</p>
                  </div>
                </div>
              </div>
            {% endif %}
            
            {% if turn.user_answer %}
              <div class="border-b border-white/10 p-4 bg-blue-500/5 hover:bg-blue-500/10 transition-colors">
                <div class="flex gap-4">
                  <div class="flex-shrink-0">
                    <div class="w-10 h-10 bg-blue-500/20 rounded-full flex items-center justify-center border border-blue-400/30">
                      <i class="fas fa-user text-blue-400"></i>
                    </div>
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-sm font-semibold text-blue-300">You</span>
                      <span class="text-xs text-gray-500">
                        {{ turn.user_answer|wordcount }} words
                      </span>
                    </div>
                    <p class="text-sm text-gray-300 leading-relaxed">{{ turn.user_answer }}</p>
                  </div>
                </div>
              </div>
            {% endif %}
          {% empty %}
            <div class="text-center py-12 px-4">
              <div class="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-comment-slash text-gray-400 text-2xl"></i>
              </div>
              <h3 class="text-lg font-semibold text-white mb-2">No Transcript Available</h3>
              <p class="text-gray-400">The interview transcript could not be loaded.</p>
            </div>
          {% endfor %}
        </div>
      </div>
    </article>

    <!-- Action Buttons -->
    <div class="flex flex-col sm:flex-row gap-4 justify-center items-center no-print animate-fade-in">
      <a href="{% url 'mock_interview:my_mock_interviews' %}" 
         class="inline-flex items-center justify-center gap-2 px-6 py-3 glass-card text-gray-300 hover:text-white rounded-xl font-medium hover:bg-white/10 transition-all duration-200 min-w-[200px]">
        <i class="fas fa-arrow-left"></i>
        <span>Back to Interviews</span>
      </a>
      
      <a href="{% url 'mock_interview:interview_setup' %}" 
         class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white rounded-xl font-semibold transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105 min-w-[200px]">
        <i class="fas fa-redo-alt"></i>
        <span>Practice Again</span>
      </a>
      
      <button onclick="window.print()" 
              class="inline-flex items-center justify-center gap-2 px-6 py-3 glass-card text-blue-300 border border-blue-400/30 hover:bg-blue-500/20 rounded-xl font-medium transition-all duration-200 min-w-[200px]">
        <i class="fas fa-print"></i>
        <span>Print Report</span>
      </button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Animate the score circle
  const scoreProgress = document.getElementById('score-progress');
  if (scoreProgress) {
    const score = {{ ai_feedback.overall_score|default:session.score|default:0 }};
    const circumference = 314; // 2 * Ï€ * 50
    const offset = circumference - (score / 100) * circumference;
    
    // Determine color based on score
    if (score >= 85) {
      scoreProgress.classList.add('stroke-emerald-500');
    } else if (score >= 70) {
      scoreProgress.classList.add('stroke-blue-500');
    } else if (score >= 50) {
      scoreProgress.classList.add('stroke-yellow-500');
    } else {
      scoreProgress.classList.add('stroke-red-500');
    }
    
    // Animate the circle
    setTimeout(() => {
      scoreProgress.style.strokeDashoffset = offset;
    }, 500);
  }
  
  // Stagger animations
  const cards = document.querySelectorAll('.animate-slide-up');
  cards.forEach((card, index) => {
    card.style.animationDelay = `${index * 0.1}s`;
  });
  
  console.log('MockMate Interview Review initialized');
});
</script>
{% endblock %}