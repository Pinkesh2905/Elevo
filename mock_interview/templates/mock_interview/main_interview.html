{% extends "base.html" %}
{% load static %}

{% block title %}Elevo Interview Studio{% endblock %}

{% block content %}
<section class="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-cyan-950 px-4 py-6">
  <div class="mx-auto grid max-w-7xl gap-6 xl:grid-cols-12">
    <aside class="space-y-5 xl:col-span-4">
      <div class="rounded-2xl border border-white/10 bg-slate-900/80 p-5 backdrop-blur">
        <div class="flex items-start justify-between">
          <div>
            <p class="text-xs uppercase tracking-[0.2em] text-cyan-300">Interview Studio</p>
            <h1 class="mt-1 text-xl font-semibold text-slate-100">{{ job_role|default:"Role Not Set" }}</h1>
          </div>
          <span id="status-chip" class="rounded-full border border-cyan-500/40 bg-cyan-500/20 px-3 py-1 text-xs text-cyan-200">Ready</span>
        </div>
        <div class="mt-4 space-y-1 text-sm text-slate-300">
          <p>Mode: <span id="track-label" class="font-semibold text-emerald-300">technical</span></p>
          <p>Question <span id="question-no" class="font-semibold text-white">1</span> / <span id="max-questions" class="font-semibold text-white">8</span></p>
          <p>Stage: <span id="stage-label" class="font-semibold text-cyan-300">introduction</span></p>
          <p>Elapsed: <span id="elapsed" class="font-semibold text-white">00:00</span></p>
        </div>
        <div class="mt-4">
          <div class="mb-2 flex items-center justify-between text-xs text-slate-400">
            <span>Progress</span>
            <span id="progress-label">0%</span>
          </div>
          <div class="h-2 rounded-full bg-slate-800">
            <div id="progress-bar" class="h-2 rounded-full bg-gradient-to-r from-cyan-500 to-emerald-500" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <div class="rounded-2xl border border-white/10 bg-slate-900/80 p-5 backdrop-blur">
        <h2 class="text-sm font-semibold text-slate-100">Plan & Skills</h2>
        <p class="mt-2 text-xs text-slate-500">Questioning follows stage-based competency tracks.</p>
        <div id="skills-wrap" class="mt-3 flex flex-wrap gap-2"></div>
        <div id="tracks-wrap" class="mt-4 space-y-2"></div>
      </div>

      <div class="rounded-2xl border border-white/10 bg-slate-900/80 p-5 backdrop-blur">
        <h2 class="text-sm font-semibold text-slate-100">Controls</h2>
        <div class="mt-3 grid grid-cols-2 gap-2">
          <button id="start-btn" class="rounded-lg bg-cyan-600 px-3 py-2 text-sm font-semibold text-white hover:bg-cyan-500">Start</button>
          <button id="finish-btn" class="rounded-lg border border-white/20 bg-white/5 px-3 py-2 text-sm text-slate-200 hover:bg-white/10">Finish</button>
          <button id="hint-btn" class="rounded-lg border border-amber-400/40 bg-amber-500/10 px-3 py-2 text-sm text-amber-200 hover:bg-amber-500/20">Hints</button>
          <button id="practice-btn" class="rounded-lg border border-emerald-400/40 bg-emerald-500/10 px-3 py-2 text-sm text-emerald-200 hover:bg-emerald-500/20">Practice</button>
          <button id="mic-btn" class="col-span-2 rounded-lg border border-white/20 bg-white/5 px-3 py-2 text-sm text-slate-200 hover:bg-white/10">Voice Input</button>
          <button id="stop-audio-btn" class="col-span-2 rounded-lg border border-white/20 bg-white/5 px-3 py-2 text-sm text-slate-200 hover:bg-white/10">Stop Voice</button>
        </div>
        <p id="voice-note" class="mt-2 text-xs text-slate-500">Mic idle.</p>
        <p class="mt-1 text-xs text-slate-500">Enter sends. Shift+Enter new line.</p>
      </div>
    </aside>

    <main class="xl:col-span-8">
      <div class="flex h-[82vh] flex-col overflow-hidden rounded-2xl border border-white/10 bg-slate-900/80 backdrop-blur">
        <div class="border-b border-white/10 px-5 py-4">
          <h2 class="text-lg font-semibold text-slate-100">Live Conversation</h2>
          <p class="text-xs text-slate-500">Professional interview simulation with adaptive stages.</p>
        </div>
        <div id="chat" class="flex-1 space-y-4 overflow-y-auto bg-[radial-gradient(circle_at_top_right,rgba(34,211,238,0.06),transparent_45%)] p-5"></div>
        <div class="border-t border-white/10 bg-slate-950/40 p-4">
          <div class="flex gap-2">
            <textarea id="answer-input" rows="3" class="flex-1 rounded-xl border border-white/20 bg-white/5 px-3 py-2 text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="Craft a clear answer with one concrete example..."></textarea>
            <button id="send-btn" class="rounded-xl bg-cyan-600 px-5 py-2 font-semibold text-white hover:bg-cyan-500">Send</button>
          </div>
        </div>
      </div>
    </main>
  </div>
</section>

<div id="coach-panel" class="fixed bottom-4 right-4 z-50 hidden w-[360px] max-w-[92vw] rounded-2xl border border-white/15 bg-slate-900/95 p-4 shadow-2xl">
  <div class="mb-2 flex items-center justify-between">
    <h3 id="coach-title" class="text-sm font-semibold text-slate-100">Coach</h3>
    <button id="coach-close" class="rounded bg-white/10 px-2 py-1 text-xs text-slate-300">Close</button>
  </div>
  <div id="coach-body" class="max-h-[320px] space-y-2 overflow-y-auto text-sm text-slate-200"></div>
</div>

<script>
  const SESSION_ID = Number("{{ session_id }}");
  const START_URL = `/mock-interview/${SESSION_ID}/start/`;
  const INTERACT_URL = `/mock-interview/${SESSION_ID}/ai_interaction/`;
  const HINT_URL = `/mock-interview/${SESSION_ID}/hints/`;
  const PRACTICE_URL = `/mock-interview/${SESSION_ID}/practice-questions/`;
  const REVIEW_URL = `/mock-interview/${SESSION_ID}/review/`;
  const INITIAL_HISTORY = {{ initial_chat_history_json|safe }};
  const INTERVIEW_PROGRESS = {{ interview_progress|safe }};
  const INTERVIEW_PLAN = {{ interview_plan_json|safe }};
  const KEY_SKILLS = "{{ key_skills|escapejs }}";

  const state = {
    active: false,
    currentQuestion: INTERVIEW_PROGRESS.current_question || 1,
    maxQuestions: INTERVIEW_PROGRESS.max_questions || 8,
    stage: INTERVIEW_PROGRESS.stage || "introduction",
    history: [],
    startAt: null,
    timer: null,
    awaiting: false,
    listening: false,
    recognition: null,
    preferredVoice: null,
  };

  const els = {
    chat: document.getElementById("chat"),
    answerInput: document.getElementById("answer-input"),
    sendBtn: document.getElementById("send-btn"),
    startBtn: document.getElementById("start-btn"),
    finishBtn: document.getElementById("finish-btn"),
    hintBtn: document.getElementById("hint-btn"),
    practiceBtn: document.getElementById("practice-btn"),
    micBtn: document.getElementById("mic-btn"),
    stopAudioBtn: document.getElementById("stop-audio-btn"),
    statusChip: document.getElementById("status-chip"),
    questionNo: document.getElementById("question-no"),
    maxQuestions: document.getElementById("max-questions"),
    stageLabel: document.getElementById("stage-label"),
    trackLabel: document.getElementById("track-label"),
    elapsed: document.getElementById("elapsed"),
    voiceNote: document.getElementById("voice-note"),
    skillsWrap: document.getElementById("skills-wrap"),
    tracksWrap: document.getElementById("tracks-wrap"),
    progressBar: document.getElementById("progress-bar"),
    progressLabel: document.getElementById("progress-label"),
    coachPanel: document.getElementById("coach-panel"),
    coachTitle: document.getElementById("coach-title"),
    coachBody: document.getElementById("coach-body"),
    coachClose: document.getElementById("coach-close"),
  };

  function token() {
    const m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? m[1] : "";
  }

  function setStatus(text, cls = "cyan") {
    const map = {
      cyan: "rounded-full border border-cyan-500/40 bg-cyan-500/20 px-3 py-1 text-xs text-cyan-200",
      green: "rounded-full border border-emerald-500/40 bg-emerald-500/20 px-3 py-1 text-xs text-emerald-200",
      amber: "rounded-full border border-amber-500/40 bg-amber-500/20 px-3 py-1 text-xs text-amber-200",
      red: "rounded-full border border-red-500/40 bg-red-500/20 px-3 py-1 text-xs text-red-200"
    };
    els.statusChip.className = map[cls] || map.cyan;
    els.statusChip.textContent = text;
  }

  function renderProgress() {
    const pct = Math.max(0, Math.min(100, Math.round((state.currentQuestion - 1) / state.maxQuestions * 100)));
    els.progressBar.style.width = `${pct}%`;
    els.progressLabel.textContent = `${pct}%`;
    els.questionNo.textContent = String(state.currentQuestion);
    els.maxQuestions.textContent = String(state.maxQuestions);
    els.stageLabel.textContent = state.stage;
    els.trackLabel.textContent = INTERVIEW_PLAN.track || "technical";
  }

  function pickPreferredVoice() {
    const voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : [];
    if (!voices || !voices.length) return null;
    const byIndianFemale = voices.find((v) => {
      const n = (v.name || "").toLowerCase();
      const l = (v.lang || "").toLowerCase();
      return (l.includes("en-in") || n.includes("india") || n.includes("indian")) && (n.includes("female") || n.includes("neerja"));
    });
    if (byIndianFemale) return byIndianFemale;
    const byIndian = voices.find((v) => (v.lang || "").toLowerCase().includes("en-in") || (v.name || "").toLowerCase().includes("india"));
    if (byIndian) return byIndian;
    const byFemaleEnglish = voices.find((v) => (v.lang || "").toLowerCase().startsWith("en") && (v.name || "").toLowerCase().includes("female"));
    if (byFemaleEnglish) return byFemaleEnglish;
    return voices.find((v) => (v.lang || "").toLowerCase().startsWith("en")) || voices[0] || null;
  }

  function speak(text) {
    if (!("speechSynthesis" in window) || !text) return;
    window.speechSynthesis.cancel();
    const utter = new SpeechSynthesisUtterance(text);
    utter.rate = 1.12;
    utter.pitch = 1.02;
    if (!state.preferredVoice) state.preferredVoice = pickPreferredVoice();
    if (state.preferredVoice) utter.voice = state.preferredVoice;
    utter.lang = state.preferredVoice?.lang || "en-IN";
    window.speechSynthesis.speak(utter);
  }

  function addMessage(role, text, meta = null) {
    state.history.push({ role, parts: [{ text }] });
    const wrap = document.createElement("div");
    wrap.className = role === "model" ? "" : "pl-8";
    const bubble = document.createElement("div");
    bubble.className = role === "model"
      ? "rounded-xl border border-cyan-500/35 bg-cyan-500/10 px-4 py-3 text-slate-100"
      : "rounded-xl border border-emerald-500/35 bg-emerald-500/10 px-4 py-3 text-slate-100";
    bubble.innerHTML = `
      <div class="mb-1 flex items-center justify-between">
        <span class="text-xs font-semibold ${role === "model" ? "text-cyan-300" : "text-emerald-300"}">${role === "model" ? "Elevo" : "You"}</span>
        ${meta ? `<span class="text-[10px] text-slate-400">${meta}</span>` : ""}
      </div>
      <div class="whitespace-pre-wrap text-sm">${text}</div>
    `;
    wrap.appendChild(bubble);
    els.chat.appendChild(wrap);
    els.chat.scrollTop = els.chat.scrollHeight;
  }

  function startTimer() {
    if (state.timer) clearInterval(state.timer);
    state.startAt = Date.now();
    state.timer = setInterval(() => {
      const sec = Math.floor((Date.now() - state.startAt) / 1000);
      const mm = String(Math.floor(sec / 60)).padStart(2, "0");
      const ss = String(sec % 60).padStart(2, "0");
      els.elapsed.textContent = `${mm}:${ss}`;
    }, 1000);
  }

  function setupSpeechInput() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) {
      els.voiceNote.textContent = "Speech recognition unavailable.";
      return;
    }
    const rec = new SR();
    rec.lang = "en-US";
    rec.interimResults = true;
    rec.continuous = false;
    let finalText = "";
    rec.onstart = () => { state.listening = true; els.voiceNote.textContent = "Listening..."; };
    rec.onresult = (event) => {
      let interim = "";
      for (let i = event.resultIndex; i < event.results.length; i += 1) {
        const t = event.results[i][0].transcript;
        if (event.results[i].isFinal) finalText += `${t} `;
        else interim += t;
      }
      els.answerInput.value = `${finalText}${interim}`.trim();
    };
    rec.onend = () => { state.listening = false; els.voiceNote.textContent = finalText ? "Voice captured." : "Mic idle."; finalText = ""; };
    rec.onerror = () => { els.voiceNote.textContent = "Voice input error."; };
    state.recognition = rec;
  }

  function renderPlan() {
    const skills = KEY_SKILLS.split(",").map((x) => x.trim()).filter(Boolean);
    const skillList = skills.length ? skills : (INTERVIEW_PLAN.skills_focus || []);
    if (!skillList.length) {
      els.skillsWrap.innerHTML = '<span class="text-xs text-slate-500">No skills provided</span>';
    } else {
      skillList.forEach((skill) => {
        const chip = document.createElement("span");
        chip.className = "rounded-lg border border-cyan-500/30 bg-cyan-500/10 px-2 py-1 text-xs text-cyan-200";
        chip.textContent = skill;
        els.skillsWrap.appendChild(chip);
      });
    }
    (INTERVIEW_PLAN.focus_tracks || []).forEach((track) => {
      const item = document.createElement("div");
      item.className = "rounded-lg border border-white/10 bg-white/5 px-3 py-2";
      item.innerHTML = `<p class="text-xs font-semibold text-slate-300">${track.stage}</p><p class="text-xs text-slate-500">${track.goal}</p>`;
      els.tracksWrap.appendChild(item);
    });
  }

  function openCoach(title, items, tone = "cyan") {
    const toneClass = tone === "amber" ? "text-amber-300" : tone === "emerald" ? "text-emerald-300" : "text-cyan-300";
    els.coachTitle.className = `text-sm font-semibold ${toneClass}`;
    els.coachTitle.textContent = title;
    els.coachBody.innerHTML = "";
    items.forEach((item, idx) => {
      const row = document.createElement("div");
      row.className = "rounded-lg border border-white/10 bg-white/5 px-3 py-2";
      row.innerHTML = `<span class="text-xs text-slate-500">${idx + 1}</span><p class="text-sm text-slate-200">${item}</p>`;
      els.coachBody.appendChild(row);
    });
    els.coachPanel.classList.remove("hidden");
  }

  async function startInterview() {
    setStatus("Starting", "amber");
    const res = await fetch(START_URL, {
      method: "POST",
      headers: { "X-CSRFToken": token(), "Content-Type": "application/json" },
      body: "{}",
    });
    const data = await res.json();
    if (!res.ok || !data.success) {
      setStatus("Error", "red");
      addMessage("model", data.error || "Unable to start interview.");
      return;
    }
    state.active = true;
    state.currentQuestion = data.current_question || 1;
    renderProgress();
    setStatus("Live", "green");
    startTimer();
    addMessage("model", data.ai_response_text || "", "start");
    speak(data.ai_response_text || "");
  }

  async function submitAnswer(requestType = "normal") {
    const text = requestType === "finish" ? "Please conclude the interview now." : els.answerInput.value.trim();
    if (!text || state.awaiting || !state.active) return;
    state.awaiting = true;
    els.sendBtn.disabled = true;
    if (requestType === "normal") {
      addMessage("user", text);
      els.answerInput.value = "";
    }
    setStatus("Processing", "amber");

    try {
      const res = await fetch(INTERACT_URL, {
        method: "POST",
        headers: { "X-CSRFToken": token(), "Content-Type": "application/json" },
        body: JSON.stringify({ user_response: text, chat_history: state.history, request_type: requestType }),
      });
      const data = await res.json();
      if (!res.ok || data.error) throw new Error(data.error || "AI request failed");

      if (data.ai_response_text) {
        addMessage("model", data.ai_response_text);
        speak(data.ai_response_text);
      }

      if (data.interview_complete) {
        setStatus("Completed", "green");
        clearInterval(state.timer);
        setTimeout(() => { window.location.href = REVIEW_URL; }, 900);
        return;
      }

      state.currentQuestion = data.interview_progress?.current_question || (state.currentQuestion + 1);
      state.stage = data.interview_progress?.stage || state.stage;
      renderProgress();
      setStatus("Live", "green");
    } catch (err) {
      setStatus("Error", "red");
      addMessage("model", `System: ${err.message}`);
    } finally {
      state.awaiting = false;
      els.sendBtn.disabled = false;
    }
  }

  async function loadHints() {
    const res = await fetch(HINT_URL, { method: "POST", headers: { "X-CSRFToken": token(), "Content-Type": "application/json" }, body: "{}" });
    const data = await res.json();
    const hints = data.hints || ["No hints available right now."];
    openCoach(`Hints (${data.context?.stage || "current"})`, hints, "amber");
  }

  async function loadPractice() {
    const res = await fetch(PRACTICE_URL, {
      method: "POST",
      headers: { "X-CSRFToken": token(), "Content-Type": "application/json" },
      body: JSON.stringify({ focus_area: KEY_SKILLS || INTERVIEW_PLAN.role || "general" }),
    });
    const data = await res.json();
    const items = (data.question_bank || []).map((q) => `[${q.type}] ${q.question}`);
    openCoach("Practice Question Bank", items.length ? items : (data.questions || []), "emerald");
  }

  els.startBtn.addEventListener("click", startInterview);
  els.sendBtn.addEventListener("click", () => submitAnswer("normal"));
  els.finishBtn.addEventListener("click", () => submitAnswer("finish"));
  els.hintBtn.addEventListener("click", loadHints);
  els.practiceBtn.addEventListener("click", loadPractice);
  els.answerInput.addEventListener("keydown", (e) => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); submitAnswer("normal"); } });
  els.stopAudioBtn.addEventListener("click", () => { if ("speechSynthesis" in window) window.speechSynthesis.cancel(); });
  els.micBtn.addEventListener("click", () => {
    if (!state.recognition) return;
    if (!state.active) { els.voiceNote.textContent = "Start interview first."; return; }
    if (state.listening) state.recognition.stop();
    else state.recognition.start();
  });
  els.coachClose.addEventListener("click", () => els.coachPanel.classList.add("hidden"));

  document.addEventListener("DOMContentLoaded", () => {
    if ("speechSynthesis" in window) {
      window.speechSynthesis.onvoiceschanged = () => {
        state.preferredVoice = pickPreferredVoice();
      };
      state.preferredVoice = pickPreferredVoice();
    }
    renderPlan();
    renderProgress();
    setupSpeechInput();
    (INITIAL_HISTORY || []).forEach((msg) => {
      const text = msg?.parts?.[0]?.text || "";
      if (text) addMessage(msg.role, text);
    });
    if (INITIAL_HISTORY && INITIAL_HISTORY.length) {
      state.active = true;
      setStatus("Live", "green");
      startTimer();
    } else {
      addMessage("model", "Welcome. Click Start to begin your professional mock interview.");
    }
  });
</script>
{% endblock %}
