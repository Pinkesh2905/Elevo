{% extends "base.html" %}
{% load static %}

{% block title %}Elevo | Premium Interview Experience{% endblock %}

{% block content %}
<section class="min-h-screen bg-slate-950 text-slate-100 flex flex-col items-center justify-center p-6 relative overflow-hidden">
  <!-- Dynamic Background Background Elements -->
  <div class="absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,rgba(34,211,238,0.1),transparent_70%)] pointer-events-none"></div>
  <div class="absolute -top-[10%] -left-[10%] w-[40%] h-[40%] bg-cyan-500/10 rounded-full blur-[120px] pointer-events-none"></div>
  <div class="absolute -bottom-[10%] -right-[10%] w-[40%] h-[40%] bg-emerald-500/10 rounded-full blur-[120px] pointer-events-none"></div>

  <!-- Top Info Bar -->
  <div class="fixed top-0 inset-x-0 h-16 bg-slate-950/50 backdrop-blur-md border-b border-white/5 flex items-center justify-between px-8 z-30">
    <div class="flex items-center gap-4">
      <div class="flex flex-col">
        <span class="text-[10px] uppercase tracking-widest text-cyan-400 font-bold">In Session</span>
        <span class="text-sm font-semibold text-slate-200">{{ job_role|default:"Software Engineer" }}</span>
      </div>
      <div class="h-8 w-px bg-white/10 hidden sm:block"></div>
      <div class="hidden sm:flex flex-col">
        <span class="text-[10px] uppercase tracking-widest text-slate-500 font-bold">Track</span>
        <span id="track-label" class="text-sm font-semibold text-emerald-400">Technical</span>
      </div>
    </div>

    <!-- Timer & Progress -->
    <div class="flex items-center gap-6">
      <div class="flex flex-col items-end">
        <span class="text-[10px] uppercase tracking-widest text-slate-500 font-bold">Time Remaining</span>
        <span id="countdown-timer" class="text-xl font-mono font-bold text-slate-100">15:00</span>
      </div>
      <div class="w-32 hidden md:block">
        <div class="flex items-center justify-between text-[10px] uppercase tracking-tighter text-slate-500 mb-1 font-bold">
          <span>Progress</span>
          <span id="progress-pct">0%</span>
        </div>
        <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
          <div id="progress-bar" class="h-full bg-gradient-to-r from-cyan-500 to-emerald-500 transition-all duration-500" style="width: 0%"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Focus Area -->
  <div class="max-w-4xl w-full flex flex-col items-center gap-12 z-10 transition-all duration-700" id="main-container">
    
    <!-- Interviewer Character -->
    <div class="relative group">
      <div id="ai-pulse" class="absolute inset-0 bg-cyan-500/20 rounded-full blur-2xl transition-all duration-1000 scale-90 opacity-0"></div>
      <div class="w-32 h-32 md:w-40 md:h-40 rounded-full border-2 border-cyan-500/30 bg-slate-900 flex items-center justify-center relative z-20 overflow-hidden shadow-[0_0_50px_rgba(34,211,238,0.15)]">
        <div class="absolute inset-0 bg-gradient-to-t from-cyan-950/40 to-transparent"></div>
        <span class="text-4xl md:text-5xl font-bold text-cyan-400 z-10">E</span>
        <!-- Speaking Waves -->
        <div id="speaking-waves" class="absolute bottom-4 flex gap-1 items-end h-6 opacity-0 transition-opacity duration-300">
          <div class="w-1 bg-cyan-400 rounded-full animate-bounce" style="animation-duration: 0.6s"></div>
          <div class="w-1 bg-cyan-400 rounded-full animate-bounce" style="animation-duration: 0.8s"></div>
          <div class="w-1 bg-cyan-400 rounded-full animate-bounce" style="animation-duration: 0.5s"></div>
          <div class="w-1 bg-cyan-400 rounded-full animate-bounce" style="animation-duration: 0.7s"></div>
        </div>
      </div>
    </div>

    <!-- Transcription Area -->
    <div class="w-full text-center space-y-4 min-h-[120px]">
      <div id="ai-name-label" class="text-[10px] uppercase tracking-widest text-cyan-400 font-bold opacity-60">Elevo (Assistant)</div>
      <div id="transcription-text" class="text-xl md:text-3xl font-medium leading-relaxed text-slate-100 px-4">
        Welcome. Press "Start Session" to begin your professional mock interview.
      </div>
    </div>

    <!-- User Response Input Area -->
    <div id="input-container" class="w-full max-w-2xl bg-slate-900/40 backdrop-blur-xl border border-white/10 rounded-3xl p-4 shadow-2xl transition-all duration-500 opacity-20 pointer-events-none">
      <div class="flex items-center gap-4 mb-3 px-2">
        <div id="mic-status-indicator" class="flex items-center gap-2">
          <div class="w-2 h-2 rounded-full bg-slate-600" id="status-dot"></div>
          <span class="text-xs font-semibold text-slate-500 uppercase tracking-widest" id="status-text">Mic Idle</span>
        </div>
        <div class="ml-auto flex items-center gap-2">
          <span class="text-[10px] text-slate-500 uppercase font-bold tracking-tighter">Turn:</span>
          <span id="turn-label" class="text-[10px] text-cyan-400 uppercase font-bold tracking-tighter">Elevo Speaking</span>
        </div>
      </div>
      
      <div class="relative group">
        <textarea id="answer-input" rows="2" 
          class="w-full bg-white/5 border border-white/5 rounded-2xl px-6 py-4 text-lg text-slate-100 placeholder:text-slate-600 focus:outline-none focus:ring-2 focus:ring-cyan-500/50 transition-all resize-none"
          placeholder="I'm listening. Speak or type your answer here..."></textarea>
        
        <div class="absolute right-3 bottom-3 flex items-center gap-2">
          <button id="mic-btn" class="p-3 rounded-xl bg-slate-800 text-slate-300 hover:bg-slate-700 hover:text-white transition-all shadow-lg active:scale-95" title="Toggle Microphone">
            <i class="ri-mic-line text-xl" id="mic-icon"></i>
          </button>
          <button id="send-btn" class="p-3 rounded-xl bg-cyan-600 text-white hover:bg-cyan-500 transition-all shadow-[0_0_20px_rgba(8,145,178,0.3)] active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="ri-send-plane-2-fill text-xl"></i>
          </button>
        </div>
      </div>
      <p class="text-[10px] text-center text-slate-600 mt-3 font-medium">Automatic turn-taking enabled. Press Enter to send manually.</p>
    </div>

  </div>

  <!-- Quick Controls & Hints -->
  <div class="fixed bottom-8 flex flex-col items-center gap-4 z-20">
    <div id="action-buttons" class="flex gap-4">
      <button id="start-btn" class="px-8 py-3 rounded-full bg-cyan-600 text-white font-bold text-lg hover:bg-cyan-500 transition-all shadow-[0_0_30px_rgba(8,145,178,0.4)] active:scale-95">
        Start Session
      </button>
      <button id="hint-btn" class="px-6 py-3 rounded-full bg-slate-900/80 backdrop-blur border border-white/10 text-slate-300 font-semibold hover:border-cyan-500/50 transition-all hidden">
        <i class="ri-lightbulb-line mr-2"></i>Live Hints
      </button>
      <button id="end-btn" class="px-6 py-3 rounded-full bg-red-950/40 backdrop-blur border border-red-500/30 text-red-200 font-semibold hover:bg-red-500/20 transition-all hidden">
        <i class="ri-stop-circle-line mr-2"></i>End Interview
      </button>
    </div>
  </div>

  <!-- Coaching Panel -->
  <div id="coach-panel" class="fixed bottom-4 right-4 z-50 transform translate-y-full transition-transform duration-500 w-[380px] max-w-[92vw]">
    <div class="bg-slate-900/95 border border-cyan-500/20 rounded-3xl p-6 shadow-2xl backdrop-blur-2xl">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
          <div class="w-2 h-6 bg-cyan-500 rounded-full"></div>
          <h3 class="font-bold text-lg text-slate-100" id="coach-title">Interview Coach</h3>
        </div>
        <button id="coach-close" class="p-2 text-slate-500 hover:text-white"><i class="ri-close-line text-xl"></i></button>
      </div>
      <div id="coach-body" class="space-y-4 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
        <!-- Hints appear here -->
      </div>
    </div>
  </div>

  <!-- Overlay for start -->
  <div id="session-overlay" class="fixed inset-0 bg-slate-950/40 backdrop-blur-sm z-0 pointer-events-none transition-opacity duration-1000"></div>
</section>

<style>
  .custom-scrollbar::-webkit-scrollbar { width: 4px; }
  .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(34,211,238,0.3); }

  @keyframes pulse {
    0% { transform: scale(0.9); opacity: 0.1; }
    50% { transform: scale(1.1); opacity: 0.4; }
    100% { transform: scale(1.3); opacity: 0; }
  }
  .pulse-active { animation: pulse 2s infinite ease-out; }
</style>

<script>
  // Configuration & State
  const SESSION_ID = Number("{{ session_id }}");
  const INTERACT_URL = `/mock-interview/${SESSION_ID}/ai_interaction/`;
  const START_URL = `/mock-interview/${SESSION_ID}/start/`;
  const HINT_URL = `/mock-interview/${SESSION_ID}/hints/`;
  const REVIEW_URL = `/mock-interview/${SESSION_ID}/review/`;

  const state = {
    active: false,
    awaiting: false,
    listening: false,
    count: 0,
    maxQuestions: parseInt("{{ interview_progress.max_questions|default:8 }}") || 8,
    currentQuestion: parseInt("{{ interview_progress.current_question|default:1 }}") || 1,
    timeRemaining: 15 * 60, // 15 minutes in seconds
    timerInterval: null,
    recognition: null,
    preferredVoice: null,
    history: JSON.parse('{{ initial_chat_history_json|safe|default:"[]" }}'),
    isSpeaking: false
  };

  const els = {
    mainContainer: document.getElementById("main-container"),
    aiPulse: document.getElementById("ai-pulse"),
    aiWaves: document.getElementById("speaking-waves"),
    transcriptionText: document.getElementById("transcription-text"),
    inputContainer: document.getElementById("input-container"),
    answerInput: document.getElementById("answer-input"),
    micBtn: document.getElementById("mic-btn"),
    micIcon: document.getElementById("mic-icon"),
    sendBtn: document.getElementById("send-btn"),
    statusDot: document.getElementById("status-dot"),
    statusText: document.getElementById("status-text"),
    turnLabel: document.getElementById("turn-label"),
    countdownTimer: document.getElementById("countdown-timer"),
    progressBar: document.getElementById("progress-bar"),
    progressPct: document.getElementById("progress-pct"),
    startBtn: document.getElementById("start-btn"),
    hintBtn: document.getElementById("hint-btn"),
    coachPanel: document.getElementById("coach-panel"),
    coachTitle: document.getElementById("coach-title"),
    coachBody: document.getElementById("coach-body"),
    coachClose: document.getElementById("coach-close"),
    endBtn: document.getElementById("end-btn")
  };

  // --- Logic Functions ---

  function CSRF_TOKEN() {
    const m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? m[1] : "";
  }

  function formatTime(seconds) {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
  }

  function startTimer() {
    state.timerInterval = setInterval(() => {
      state.timeRemaining--;
      els.countdownTimer.textContent = formatTime(state.timeRemaining);
      
      if (state.timeRemaining <= 60) {
        els.countdownTimer.classList.add("text-red-500", "animate-pulse");
      }
      
      if (state.timeRemaining <= 0) {
        clearInterval(state.timerInterval);
        submitAnswer("finish");
      }
    }, 1000);
  }

  function updateProgress() {
    const pct = Math.round(((state.currentQuestion - 1) / state.maxQuestions) * 100);
    els.progressBar.style.width = `${pct}%`;
    els.progressPct.textContent = `${pct}%`;
  }

  // Word-by-word reveal logic with fixed spacing
  async function revealText(text) {
    if (!text) return;
    els.transcriptionText.innerHTML = "";
    const words = text.split(/\s+/).filter(w => w.length > 0);
    
    for (let word of words) {
      const span = document.createElement("span");
      span.textContent = word;
      // margin-right ensures words don't glue together
      span.className = "opacity-0 transition-opacity duration-200 inline-block mr-[0.3em]";
      els.transcriptionText.appendChild(span);
      
      await new Promise(r => setTimeout(r, 60)); 
      span.classList.remove("opacity-0");
      
      const container = els.transcriptionText.parentElement;
      if (container.scrollHeight > container.clientHeight) {
        container.scrollTop = container.scrollHeight;
      }
    }
  }

  // Voice Interaction
  function pickVoice() {
    const voices = window.speechSynthesis.getVoices();
    // Search for friendly, natural sounding voices
    const targets = ["Microsoft Aria", "Google US English", "Google UK English Female", "Samantha", "Microsoft Zira"];
    for (const name of targets) {
      const found = voices.find(v => v.name.includes(name));
      if (found) return found;
    }
    return voices.find(v => v.lang.includes("en-US") || v.lang.includes("en-GB")) || voices[0];
  }

  function speak(text) {
    return new Promise((resolve) => {
      state.isSpeaking = true;
      toggleSpeakingUI(true);
      
      const utter = new SpeechSynthesisUtterance(text);
      utter.voice = state.preferredVoice || pickVoice();
      utter.rate = 1.05;
      utter.pitch = 1.0;
      
      utter.onend = () => {
        state.isSpeaking = false;
        toggleSpeakingUI(false);
        resolve();
      };
      
      utter.onerror = () => {
        state.isSpeaking = false;
        toggleSpeakingUI(false);
        resolve();
      }

      window.speechSynthesis.speak(utter);
      
      // Simultaneous text reveal
      revealText(text);
    });
  }

  function toggleSpeakingUI(isSpeaking) {
    if (isSpeaking) {
      els.aiPulse.classList.add("pulse-active", "opacity-100");
      els.aiWaves.classList.remove("opacity-0");
      els.turnLabel.textContent = "Elevo Speaking";
      els.turnLabel.classList.replace("text-emerald-400", "text-cyan-400");
      
      // Block input
      els.inputContainer.classList.add("opacity-20", "pointer-events-none");
    } else {
      els.aiPulse.classList.remove("pulse-active", "opacity-100");
      els.aiWaves.classList.add("opacity-0");
      els.turnLabel.textContent = "Your Turn";
      els.turnLabel.classList.replace("text-cyan-400", "text-emerald-400");
      
      // Enable input and auto-listen
      els.inputContainer.classList.remove("opacity-20", "pointer-events-none");
      startListening();
    }
  }

  function setupSpeech() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return;

    state.recognition = new SR();
    state.recognition.lang = 'en-US';
    state.recognition.continuous = false;
    state.recognition.interimResults = true;

    state.recognition.onstart = () => {
        state.listening = true;
        els.statusDot.classList.replace("bg-slate-600", "bg-emerald-500");
        els.statusDot.classList.add("animate-pulse");
        els.statusText.textContent = "Listening...";
        els.micIcon.classList.replace("ri-mic-line", "ri-mic-fill");
        els.micBtn.classList.add("ring-2", "ring-emerald-500/50");
    };

    state.recognition.onresult = (event) => {
        let transcript = "";
        for (let i = event.resultIndex; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript;
        }
        els.answerInput.value = transcript;
    };

    state.recognition.onend = () => {
        state.listening = false;
        els.statusDot.classList.remove("animate-pulse");
        els.statusDot.classList.replace("bg-emerald-500", "bg-slate-600");
        els.statusText.textContent = "Mic Idle";
        els.micIcon.classList.replace("ri-mic-fill", "ri-mic-line");
        els.micBtn.classList.remove("ring-2", "ring-emerald-500/50");

        // Auto-submit if text exists and not manual
        if (els.answerInput.value.trim().length > 10) {
          // Delay a bit to let user breathe
          setTimeout(() => {
            if (!state.awaiting && !state.isSpeaking) submitAnswer();
          }, 1500);
        }
    };
  }

  function startListening() {
    if (state.recognition && !state.listening) {
        try { state.recognition.start(); } catch(e) {}
    }
  }

  function stopListening() {
    if (state.recognition && state.listening) {
        state.recognition.stop();
    }
  }

  // --- API Interaction ---

  async function submitAnswer(type = "normal") {
    const text = type === "finish" ? "Wrap up the interview." : els.answerInput.value.trim();
    if (!text && type !== "finish") return;
    
    // UI Feedback
    state.awaiting = true;
    els.statusText.textContent = "Analyzing...";
    els.statusDot.classList.replace("bg-slate-600", "bg-amber-500");
    els.sendBtn.disabled = true;
    stopListening();

    try {
      const res = await fetch(INTERACT_URL, {
        method: "POST",
        headers: { "X-CSRFToken": CSRF_TOKEN(), "Content-Type": "application/json" },
        body: JSON.stringify({ 
          user_response: text, 
          chat_history: state.history, 
          request_type: type,
          time_remaining: state.timeRemaining
        })
      });
      
      const data = await res.json();
      if (!res.ok || data.error) throw new Error(data.error);

      // Update state
      state.history.push({ role: "user", parts: [{ text }] });
      state.history.push({ role: "model", parts: [{ text: data.ai_response_text }] });
      state.currentQuestion = data.interview_progress?.current_question || state.currentQuestion;
      
      els.answerInput.value = "";
      updateProgress();

      if (data.interview_complete) {
        await speak(data.ai_response_text);
        window.location.href = REVIEW_URL;
        return;
      }

      // Voice response
      await speak(data.ai_response_text);
      
      // Auto-load hints in background for the next question
      loadHints();

    } catch (err) {
      console.error(err);
      revealText("I'm sorry, I encountered a connection issue. Please try again.");
    } finally {
      state.awaiting = false;
      els.sendBtn.disabled = false;
      els.statusDot.classList.replace("bg-amber-500", "bg-slate-600");
    }
  }

  async function startInterview() {
    els.startBtn.disabled = true;
    els.startBtn.classList.add("opacity-50");
    
    try {
      const res = await fetch(START_URL, {
        method: "POST",
        headers: { "X-CSRFToken": CSRF_TOKEN(), "Content-Type": "application/json" }
      });
      const data = await res.json();
      
      if (data.success) {
        state.active = true;
        els.startBtn.classList.add("hidden");
        els.hintBtn.classList.remove("hidden");
        els.endBtn.classList.remove("hidden");
        startTimer();
        await speak(data.ai_response_text);
      }
    } catch (e) {
      console.error(e);
    }
  }

  async function loadHints() {
    try {
      const res = await fetch(HINT_URL, { 
        method: "POST", 
        headers: { "X-CSRFToken": CSRF_TOKEN(), "Content-Type": "application/json" } 
      });
      const data = await res.json();
      if (data.hints && data.hints.length) {
        els.coachBody.innerHTML = "";
        data.hints.forEach(hint => {
          const div = document.createElement("div");
          div.className = "bg-white/5 border border-white/5 p-4 rounded-2xl text-sm text-slate-300";
          div.innerHTML = `<i class="ri-check-line text-cyan-400 mr-2"></i> ${hint}`;
          els.coachBody.appendChild(div);
        });
        // Show hint button notification
        els.hintBtn.classList.add("ring-2", "ring-cyan-500/50");
      }
    } catch (e) {}
  }

  // --- Event Listeners ---

  els.startBtn.addEventListener("click", startInterview);
  
  els.sendBtn.addEventListener("click", () => submitAnswer());
  
  els.answerInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      submitAnswer();
    }
  });

  els.micBtn.addEventListener("click", () => {
    if (state.listening) stopListening();
    else startListening();
  });

  els.hintBtn.addEventListener("click", () => {
    els.coachPanel.classList.remove("translate-y-full");
    els.hintBtn.classList.remove("ring-2");
  });

  els.coachClose.addEventListener("click", () => {
    els.coachPanel.classList.add("translate-y-full");
  });

  els.endBtn.addEventListener("click", () => {
    if (confirm("Are you sure you want to end the interview early? You will still get your feedback for completed questions.")) {
      submitAnswer("finish");
    }
  });

  // Init
  window.speechSynthesis.onvoiceschanged = () => {
    state.preferredVoice = pickVoice();
  };

  document.addEventListener("DOMContentLoaded", () => {
    setupSpeech();
    updateProgress();
    
    // Check if session already started
    if (state.history.length > 0) {
      state.active = true;
      els.startBtn.classList.add("hidden");
      els.hintBtn.classList.remove("hidden");
      els.endBtn.classList.remove("hidden");
      els.inputContainer.classList.remove("opacity-20", "pointer-events-none");
      startTimer();
      const lastMsg = state.history.filter(h => h.role === "model").pop();
      if (lastMsg) els.transcriptionText.textContent = lastMsg.parts[0].text;
    }
  });
</script>
{% endblock %}
