{% extends "base.html" %}

{% block title %}Admin Dashboard | Elevo{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-950 py-10">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div class="mb-8 flex flex-wrap items-start justify-between gap-4">
      <div>
        <h1 class="text-3xl font-bold text-white sm:text-4xl">Admin Operations Dashboard</h1>
        <p class="mt-2 text-sm text-slate-300">Platform health, moderation queues, and recent activity in one place.</p>
      </div>
      <div class="flex gap-3">
        <a href="{% url 'users:admin_users' %}" class="rounded-lg border border-slate-700 bg-slate-900 px-4 py-2 text-sm font-semibold text-slate-100 hover:border-sky-500 hover:text-sky-300">Manage Users</a>
        <a href="/admin/" class="rounded-lg bg-sky-600 px-4 py-2 text-sm font-semibold text-white hover:bg-sky-500">Django Admin</a>
      </div>
    </div>

    <div class="grid gap-4 sm:grid-cols-2 xl:grid-cols-4">
      <div class="rounded-xl border border-slate-800 bg-slate-900/70 p-4">
        <p class="text-xs uppercase tracking-wide text-slate-400">Total Users</p>
        <p class="mt-2 text-3xl font-bold text-white">{{ platform_metrics.total_users }}</p>
        <p class="mt-1 text-xs text-slate-400">{{ platform_metrics.active_users }} active, {{ platform_metrics.inactive_users }} inactive</p>
      </div>
      <div class="rounded-xl border border-slate-800 bg-slate-900/70 p-4">
        <p class="text-xs uppercase tracking-wide text-slate-400">Pending Actions</p>
        <p class="mt-2 text-3xl font-bold text-amber-300">{{ platform_metrics.total_pending_actions }}</p>
        <p class="mt-1 text-xs text-slate-400">Tutor reviews, inactive problems, interview reviews</p>
      </div>
      <div class="rounded-xl border border-slate-800 bg-slate-900/70 p-4">
        <p class="text-xs uppercase tracking-wide text-slate-400">Problems</p>
        <p class="mt-2 text-3xl font-bold text-white">{{ platform_metrics.total_problems }}</p>
        <p class="mt-1 text-xs text-slate-400">{{ platform_metrics.active_problems }} active, {{ platform_metrics.inactive_problems }} inactive</p>
      </div>
      <div class="rounded-xl border border-slate-800 bg-slate-900/70 p-4">
        <p class="text-xs uppercase tracking-wide text-slate-400">Submissions (7 Days)</p>
        <p class="mt-2 text-3xl font-bold text-white">{{ platform_metrics.weekly_submissions }}</p>
        <p class="mt-1 text-xs text-slate-400">{{ platform_metrics.weekly_acceptance_rate }}% accepted</p>
      </div>
    </div>

    <div class="mt-8 grid gap-6 lg:grid-cols-3">
      <div class="rounded-xl border border-slate-800 bg-slate-900/70 p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-white">Tutor Approval Queue</h2>
          <span class="rounded-full bg-amber-500/20 px-2.5 py-1 text-xs font-semibold text-amber-300">{{ platform_metrics.pending_tutor_reviews }}</span>
        </div>
        <div class="mt-4 space-y-3">
          {% for application in pending_tutor_applications|slice:":5" %}
            <div class="rounded-lg border border-slate-800 bg-slate-950/70 p-3">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <p class="text-sm font-semibold text-white">{{ application.user.username }}</p>
                  <p class="text-xs text-slate-400">{{ application.get_status_display }} • {{ application.updated_at|timesince }} ago</p>
                </div>
                <a href="{% url 'users:public_profile' application.user.username %}" class="text-xs font-semibold text-sky-300 hover:text-sky-200">Profile</a>
              </div>
              <div class="mt-2 flex gap-2">
                <form method="post" action="{% url 'users:approve_tutor' application.user.id %}" class="flex-1">
                  {% csrf_token %}
                  <button type="submit" class="w-full rounded-md bg-emerald-600 px-2 py-1.5 text-xs font-semibold text-white hover:bg-emerald-500">Approve</button>
                </form>
                <form method="post" action="{% url 'users:reject_tutor' application.user.id %}" class="flex-1">
                  {% csrf_token %}
                  <button type="submit" class="w-full rounded-md bg-rose-600 px-2 py-1.5 text-xs font-semibold text-white hover:bg-rose-500">Reject</button>
                </form>
              </div>
            </div>
          {% empty %}
            <p class="rounded-lg border border-slate-800 bg-slate-950/70 p-3 text-sm text-slate-300">No tutor reviews pending.</p>
          {% endfor %}
        </div>
      </div>

      <div class="rounded-xl border border-slate-800 bg-slate-900/70 p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-white">Problem Activation Queue</h2>
          <span class="rounded-full bg-amber-500/20 px-2.5 py-1 text-xs font-semibold text-amber-300">{{ platform_metrics.inactive_problems }}</span>
        </div>
        <div class="mt-4 space-y-3">
          {% for problem in pending_problems|slice:":5" %}
            <div class="rounded-lg border border-slate-800 bg-slate-950/70 p-3">
              <p class="text-sm font-semibold text-white">{{ problem.title }}</p>
              <p class="mt-1 text-xs text-slate-400">#{{ problem.problem_number }} • {{ problem.get_difficulty_display }}</p>
              <div class="mt-2 flex gap-2">
                <a href="{% url 'practice:problem_detail' problem.slug %}" class="rounded-md border border-slate-700 px-2 py-1.5 text-xs font-semibold text-slate-200 hover:border-sky-500 hover:text-sky-300">View</a>
                <a href="{% url 'practice:admin_activate_problem' problem.slug %}" class="rounded-md bg-emerald-600 px-2 py-1.5 text-xs font-semibold text-white hover:bg-emerald-500">Activate</a>
              </div>
            </div>
          {% empty %}
            <p class="rounded-lg border border-slate-800 bg-slate-950/70 p-3 text-sm text-slate-300">No inactive problems.</p>
          {% endfor %}
        </div>
      </div>

      <div class="rounded-xl border border-slate-800 bg-slate-900/70 p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-white">Interview Review Queue</h2>
          <span class="rounded-full bg-amber-500/20 px-2.5 py-1 text-xs font-semibold text-amber-300">{{ platform_metrics.pending_interview_reviews }}</span>
        </div>
        <div class="mt-4 space-y-3">
          {% for interview in pending_interview_reviews|slice:":5" %}
            <div class="rounded-lg border border-slate-800 bg-slate-950/70 p-3">
              <p class="text-sm font-semibold text-white">{{ interview.user.username }}</p>
              <p class="mt-1 text-xs text-slate-400">{{ interview.job_role|default:"Role not set" }} • {{ interview.updated_at|timesince }} ago</p>
              <a href="/admin/mock_interview/mockinterviewsession/{{ interview.id }}/change/" class="mt-2 inline-block rounded-md border border-slate-700 px-2 py-1.5 text-xs font-semibold text-slate-200 hover:border-sky-500 hover:text-sky-300">Open Review</a>
            </div>
          {% empty %}
            <p class="rounded-lg border border-slate-800 bg-slate-950/70 p-3 text-sm text-slate-300">No interview reviews pending.</p>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="mt-8 grid gap-6 lg:grid-cols-2">
      <div class="rounded-xl border border-slate-800 bg-slate-900/70 p-5">
        <h2 class="text-lg font-semibold text-white">Platform Distribution</h2>
        <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
          <div class="rounded-lg border border-slate-800 bg-slate-950/70 p-3 text-slate-300">Students: <span class="font-semibold text-white">{{ role_counts.STUDENT }}</span></div>
          <div class="rounded-lg border border-slate-800 bg-slate-950/70 p-3 text-slate-300">Tutors: <span class="font-semibold text-white">{{ role_counts.TUTOR }}</span></div>
          <div class="rounded-lg border border-slate-800 bg-slate-950/70 p-3 text-slate-300">Admins: <span class="font-semibold text-white">{{ role_counts.ADMIN }}</span></div>
          <div class="rounded-lg border border-slate-800 bg-slate-950/70 p-3 text-slate-300">New Users (7d): <span class="font-semibold text-white">{{ platform_metrics.recent_signups }}</span></div>
          <div class="rounded-lg border border-slate-800 bg-slate-950/70 p-3 text-slate-300">Approved Tutors: <span class="font-semibold text-white">{{ platform_metrics.approved_tutors }}</span></div>
          <div class="rounded-lg border border-slate-800 bg-slate-950/70 p-3 text-slate-300">Dormant Users (30d): <span class="font-semibold text-white">{{ platform_metrics.stale_users_count }}</span></div>
        </div>
      </div>

      <div class="rounded-xl border border-slate-800 bg-slate-900/70 p-5">
        <h2 class="text-lg font-semibold text-white">Tutor Pipeline</h2>
        <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
          <div class="rounded-lg border border-slate-800 bg-slate-950/70 p-3 text-slate-300">Draft: <span class="font-semibold text-white">{{ tutor_status_counts.DRAFT }}</span></div>
          <div class="rounded-lg border border-slate-800 bg-slate-950/70 p-3 text-slate-300">Submitted: <span class="font-semibold text-white">{{ tutor_status_counts.SUBMITTED }}</span></div>
          <div class="rounded-lg border border-slate-800 bg-slate-950/70 p-3 text-slate-300">Under Review: <span class="font-semibold text-white">{{ tutor_status_counts.UNDER_REVIEW }}</span></div>
          <div class="rounded-lg border border-slate-800 bg-slate-950/70 p-3 text-slate-300">Approved: <span class="font-semibold text-white">{{ tutor_status_counts.APPROVED }}</span></div>
          <div class="rounded-lg border border-slate-800 bg-slate-950/70 p-3 text-slate-300">Rejected: <span class="font-semibold text-white">{{ tutor_status_counts.REJECTED }}</span></div>
          <div class="rounded-lg border border-slate-800 bg-slate-950/70 p-3 text-slate-300">Total Interviews: <span class="font-semibold text-white">{{ platform_metrics.total_interviews }}</span></div>
        </div>
      </div>
    </div>

    <div class="mt-8 grid gap-6 xl:grid-cols-3">
      <div class="rounded-xl border border-slate-800 bg-slate-900/70 p-5 xl:col-span-2">
        <h2 class="text-lg font-semibold text-white">Recent User Registrations</h2>
        <div class="mt-4 overflow-x-auto">
          <table class="min-w-full text-left text-sm">
            <thead class="text-slate-400">
              <tr>
                <th class="pb-2 pr-4">User</th>
                <th class="pb-2 pr-4">Role</th>
                <th class="pb-2 pr-4">Joined</th>
                <th class="pb-2 pr-4">Status</th>
              </tr>
            </thead>
            <tbody>
              {% for user in recent_users %}
                <tr class="border-t border-slate-800">
                  <td class="py-2 pr-4 text-white">{{ user.username }}</td>
                  <td class="py-2 pr-4 text-slate-300">{{ user.profile.get_role_display|default:"Unknown" }}</td>
                  <td class="py-2 pr-4 text-slate-300">{{ user.date_joined|date:"M d, Y H:i" }}</td>
                  <td class="py-2 pr-4">
                    {% if user.is_active %}
                      <span class="rounded bg-emerald-500/20 px-2 py-0.5 text-xs font-semibold text-emerald-300">Active</span>
                    {% else %}
                      <span class="rounded bg-rose-500/20 px-2 py-0.5 text-xs font-semibold text-rose-300">Inactive</span>
                    {% endif %}
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="4" class="py-3 text-slate-300">No users found.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="rounded-xl border border-slate-800 bg-slate-900/70 p-5">
        <h2 class="text-lg font-semibold text-white">Social Snapshot</h2>
        <div class="mt-4 space-y-3 text-sm">
          <div class="flex items-center justify-between rounded-lg border border-slate-800 bg-slate-950/70 p-3">
            <span class="text-slate-300">Posts</span>
            <span class="font-semibold text-white">{{ social_stats.posts }}</span>
          </div>
          <div class="flex items-center justify-between rounded-lg border border-slate-800 bg-slate-950/70 p-3">
            <span class="text-slate-300">Comments</span>
            <span class="font-semibold text-white">{{ social_stats.comments }}</span>
          </div>
          <div class="flex items-center justify-between rounded-lg border border-slate-800 bg-slate-950/70 p-3">
            <span class="text-slate-300">Follow Links</span>
            <span class="font-semibold text-white">{{ social_stats.follows }}</span>
          </div>
          <div class="flex items-center justify-between rounded-lg border border-slate-800 bg-slate-950/70 p-3">
            <span class="text-slate-300">Interviews (7d)</span>
            <span class="font-semibold text-white">{{ platform_metrics.interviews_this_week }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-8 grid gap-6 lg:grid-cols-2">
      <div class="rounded-xl border border-slate-800 bg-slate-900/70 p-5">
        <h2 class="text-lg font-semibold text-white">Recent Code Submissions</h2>
        <div class="mt-4 space-y-3">
          {% for submission in recent_submissions %}
            <div class="rounded-lg border border-slate-800 bg-slate-950/70 p-3">
              <div class="flex items-center justify-between">
                <p class="text-sm font-semibold text-white">{{ submission.user.username }} • {{ submission.problem.title }}</p>
                <span class="text-xs text-slate-400">{{ submission.created_at|timesince }} ago</span>
              </div>
              <p class="mt-1 text-xs text-slate-300">Language: {{ submission.language }} • Status: {{ submission.get_status_display }}</p>
            </div>
          {% empty %}
            <p class="rounded-lg border border-slate-800 bg-slate-950/70 p-3 text-sm text-slate-300">No submissions found.</p>
          {% endfor %}
        </div>
      </div>

      <div class="rounded-xl border border-slate-800 bg-slate-900/70 p-5">
        <h2 class="text-lg font-semibold text-white">Recent Mock Interviews</h2>
        <div class="mt-4 space-y-3">
          {% for interview in recent_interviews %}
            <div class="rounded-lg border border-slate-800 bg-slate-950/70 p-3">
              <div class="flex items-center justify-between">
                <p class="text-sm font-semibold text-white">{{ interview.user.username }}</p>
                <span class="text-xs text-slate-400">{{ interview.created_at|timesince }} ago</span>
              </div>
              <p class="mt-1 text-xs text-slate-300">{{ interview.job_role|default:"Role not set" }} • {{ interview.get_status_display }}</p>
            </div>
          {% empty %}
            <p class="rounded-lg border border-slate-800 bg-slate-950/70 p-3 text-sm text-slate-300">No interview sessions found.</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
