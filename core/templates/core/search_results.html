{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Search{% if query %}: {{ query }}{% endif %} | Elevo{% endblock %}

{% block extra_css %}
<style>
  .result-card {
    transition: all 0.25s ease;
    border: 1px solid rgba(255, 255, 255, 0.08);
  }
  .result-card:hover {
    border-color: rgba(14, 165, 233, 0.3);
    background: rgba(14, 165, 233, 0.04);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.3);
  }
  .search-input:focus {
    border-color: rgba(14, 165, 233, 0.5);
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.12);
  }
  .tab-btn { transition: all 0.2s ease; }
  .tab-btn.active {
    color: #0ea5e9;
    border-bottom: 2px solid #0ea5e9;
    background: rgba(14, 165, 233, 0.06);
  }
  .tab-btn:hover:not(.active) { color: #94a3b8; background: rgba(255,255,255,0.03); }
  .avatar-ring { box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.3); }
  .post-card-line { border-left: 3px solid rgba(14, 165, 233, 0.25); }
  @keyframes fadeInUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
  .fade-in { animation: fadeInUp 0.35s ease forwards; }
  .fade-in:nth-child(1) { animation-delay: 0.05s; }
  .fade-in:nth-child(2) { animation-delay: 0.1s; }
  .fade-in:nth-child(3) { animation-delay: 0.15s; }
  .fade-in:nth-child(4) { animation-delay: 0.2s; }
  .fade-in:nth-child(5) { animation-delay: 0.25s; }
</style>
{% endblock %}

{% block content %}
<section class="min-h-screen py-8 px-4">
  <div class="mx-auto max-w-4xl">

    <!-- Header + Search Bar -->
    <div class="mb-8">
      <h1 class="text-2xl font-bold text-slate-100 brand-font flex items-center gap-3 mb-5">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-sky-500/20 to-violet-500/20 border border-sky-500/30 flex items-center justify-center">
          <i class="ri-search-line text-sky-400 text-lg"></i>
        </div>
        Search
      </h1>
      <form method="get" action="{% url 'search' %}" class="relative">
        <i class="ri-search-line absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 text-lg"></i>
        <input type="text" name="q" value="{{ query }}" placeholder="Search users, posts..."
               class="w-full pl-12 pr-28 py-3.5 rounded-2xl border border-white/10 bg-slate-900/75 backdrop-blur-xl text-slate-200 text-sm placeholder:text-slate-500 focus:outline-none search-input transition-all"
               autofocus>
        <button type="submit" class="absolute right-3 top-1/2 -translate-y-1/2 px-5 py-2 rounded-xl bg-gradient-to-r from-sky-500 to-teal-500 text-white text-xs font-semibold hover:from-sky-600 hover:to-teal-600 transition-all shadow-lg shadow-sky-500/15">
          Search
        </button>
      </form>
    </div>

    {% if query %}
      <!-- Tabs -->
      <div class="flex gap-1 mb-6 rounded-xl border border-white/10 bg-slate-900/60 backdrop-blur-xl p-1 overflow-x-auto">
        <button class="tab-btn active flex-1 py-2.5 px-4 rounded-lg text-sm font-medium text-slate-400 text-center" data-tab="all">
          All
        </button>
        <button class="tab-btn flex-1 py-2.5 px-4 rounded-lg text-sm font-medium text-slate-400 text-center" data-tab="users">
          <i class="ri-user-line mr-1"></i> Users
          {% if users %}<span class="ml-1 text-xs text-sky-400/80">({{ users|length }})</span>{% endif %}
        </button>
        <button class="tab-btn flex-1 py-2.5 px-4 rounded-lg text-sm font-medium text-slate-400 text-center" data-tab="posts">
          <i class="ri-article-line mr-1"></i> Posts
          {% if posts %}<span class="ml-1 text-xs text-sky-400/80">({{ posts|length }})</span>{% endif %}
        </button>
      </div>

      {% if not users and not posts %}
        <!-- No Results -->
        <div class="rounded-2xl border border-white/10 bg-slate-900/75 backdrop-blur-xl py-20 text-center">
          <div class="w-20 h-20 mx-auto rounded-2xl bg-gradient-to-br from-slate-700/40 to-slate-800/40 border border-white/10 flex items-center justify-center mb-4">
            <i class="ri-search-line text-3xl text-slate-500"></i>
          </div>
          <h3 class="text-lg font-semibold text-slate-300 brand-font">No results found</h3>
          <p class="text-sm text-slate-500 mt-1 max-w-sm mx-auto">
            We couldn't find anything matching "<span class="text-slate-300">{{ query }}</span>". Try a different search term.
          </p>
          <div class="flex gap-3 justify-center mt-6">
            <a href="{% url 'home' %}" class="px-5 py-2 rounded-xl bg-sky-500/15 border border-sky-500/25 text-sky-400 text-sm font-medium hover:bg-sky-500/25 transition-all">
              <i class="ri-home-line mr-1"></i> Go Home
            </a>
            <button onclick="history.back()" class="px-5 py-2 rounded-xl bg-white/5 border border-white/10 text-slate-400 text-sm font-medium hover:bg-white/10 transition-all">
              <i class="ri-arrow-left-line mr-1"></i> Go Back
            </button>
          </div>
        </div>
      {% else %}

        <!-- Users Section -->
        {% if users %}
        <div class="mb-8 search-section" data-section="users">
          <div class="flex items-center gap-2 mb-4">
            <div class="w-7 h-7 rounded-lg bg-cyan-500/15 border border-cyan-500/25 flex items-center justify-center">
              <i class="ri-user-line text-cyan-400 text-sm"></i>
            </div>
            <h2 class="text-sm font-semibold text-slate-300 uppercase tracking-wider">People</h2>
            <span class="text-xs text-slate-600">({{ users|length }})</span>
          </div>
          <div class="space-y-2">
            {% for u in users %}
            <a href="{% url 'users:public_profile' u.username %}"
               class="result-card fade-in flex items-center gap-4 px-5 py-4 rounded-xl bg-slate-900/60 backdrop-blur-xl cursor-pointer block">
              <!-- Avatar -->
              {% if u.profile.avatar %}
                <img src="{{ u.profile.avatar.url }}" alt="{{ u.username }}"
                     class="w-12 h-12 rounded-full object-cover avatar-ring flex-shrink-0">
              {% else %}
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-cyan-500 to-emerald-500 text-white text-lg font-bold flex items-center justify-center flex-shrink-0 avatar-ring">
                  {{ u.username|first|upper }}
                </div>
              {% endif %}

              <!-- User Info -->
              <div class="min-w-0 flex-1">
                <div class="flex items-center gap-2">
                  <span class="font-semibold text-slate-100 text-sm truncate">
                    {{ u.get_full_name|default:u.username }}
                  </span>
                  {% if u.profile.role == 'TUTOR' %}
                    <span class="px-2 py-0.5 rounded-full text-[10px] font-bold uppercase bg-violet-500/15 text-violet-400 border border-violet-500/25">Tutor</span>
                  {% elif u.profile.role == 'ADMIN' %}
                    <span class="px-2 py-0.5 rounded-full text-[10px] font-bold uppercase bg-amber-500/15 text-amber-400 border border-amber-500/25">Admin</span>
                  {% endif %}
                </div>
                <p class="text-xs text-slate-500 mt-0.5">@{{ u.username }}</p>
              </div>

              <!-- Arrow -->
              <div class="flex-shrink-0 text-slate-600 group-hover:text-sky-400 transition-colors">
                <i class="ri-arrow-right-s-line text-xl"></i>
              </div>
            </a>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Posts Section -->
        {% if posts %}
        <div class="mb-8 search-section" data-section="posts">
          <div class="flex items-center gap-2 mb-4">
            <div class="w-7 h-7 rounded-lg bg-teal-500/15 border border-teal-500/25 flex items-center justify-center">
              <i class="ri-article-line text-teal-400 text-sm"></i>
            </div>
            <h2 class="text-sm font-semibold text-slate-300 uppercase tracking-wider">Posts</h2>
            <span class="text-xs text-slate-600">({{ posts|length }})</span>
          </div>
          <div class="space-y-2">
            {% for post in posts %}
            <a href="{% url 'posts:post_detail' post.id %}"
               class="result-card fade-in rounded-xl bg-slate-900/60 backdrop-blur-xl px-5 py-4 block cursor-pointer">
              <div class="flex items-start gap-3">
                <!-- Author Avatar -->
                {% if post.author.profile.avatar %}
                  <img src="{{ post.author.profile.avatar.url }}" alt="{{ post.author.username }}"
                       class="w-9 h-9 rounded-full object-cover border border-white/15 flex-shrink-0 mt-0.5">
                {% else %}
                  <div class="w-9 h-9 rounded-full bg-gradient-to-br from-teal-500 to-cyan-500 text-white text-sm font-bold flex items-center justify-center flex-shrink-0 mt-0.5">
                    {{ post.author.username|first|upper }}
                  </div>
                {% endif %}

                <div class="min-w-0 flex-1">
                  <!-- Author Name + Time -->
                  <div class="flex items-center gap-2 mb-1.5">
                    <span class="text-sm font-medium text-slate-200">{{ post.author.get_full_name|default:post.author.username }}</span>
                    <span class="text-slate-600">Â·</span>
                    <span class="text-xs text-slate-500">{{ post.created_at|naturaltime }}</span>
                  </div>
                  <!-- Post Content Preview -->
                  <div class="post-card-line pl-3">
                    <p class="text-sm text-slate-400 line-clamp-2">{{ post.content|truncatechars:150 }}</p>
                  </div>
                  <!-- Stats -->
                  <div class="flex items-center gap-4 mt-2.5 text-xs text-slate-500">
                    {% if post.likes_count %}
                      <span class="flex items-center gap-1"><i class="ri-heart-line text-rose-400/60"></i> {{ post.likes_count }}</span>
                    {% endif %}
                    {% if post.comments_count %}
                      <span class="flex items-center gap-1"><i class="ri-chat-1-line text-sky-400/60"></i> {{ post.comments_count }}</span>
                    {% endif %}
                    <span class="flex items-center gap-1"><i class="ri-time-line"></i> {{ post.created_at|timesince }} ago</span>
                  </div>
                </div>
              </div>
            </a>
            {% endfor %}
          </div>
        </div>
        {% endif %}

      {% endif %}

    {% else %}
      <!-- Initial State (no query) -->
      <div class="rounded-2xl border border-white/10 bg-slate-900/75 backdrop-blur-xl py-20 text-center">
        <div class="w-20 h-20 mx-auto rounded-2xl bg-gradient-to-br from-sky-500/10 to-violet-500/10 border border-sky-500/20 flex items-center justify-center mb-4">
          <i class="ri-compass-discover-line text-3xl text-sky-400/60"></i>
        </div>
        <h3 class="text-lg font-semibold text-slate-300 brand-font">Discover Elevo</h3>
        <p class="text-sm text-slate-500 mt-1 max-w-sm mx-auto">
          Search for people and posts across the platform.
        </p>
      </div>
    {% endif %}

  </div>
</section>

<script>
  // Tab filtering
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      const tab = this.dataset.tab;
      document.querySelectorAll('.search-section').forEach(s => {
        if (tab === 'all') {
          s.style.display = '';
        } else {
          s.style.display = s.dataset.section === tab ? '' : 'none';
        }
      });
    });
  });
</script>
{% endblock %}